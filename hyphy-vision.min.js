var root=this;var datamonkey=function(){};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=Datamonkey}exports.datamonkey=datamonkey}else{root.datamonkey=datamonkey}datamonkey.errorModal=function(e){$("#modal-error-msg").text(e);$("#errorModal").modal()};datamonkey.export_csv_button=function(e){e=d3.csv.format(e);if(e!=null){var t=document.createElement("a");t.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(e));t.setAttribute("download","export.csv");t.className="btn btn-default btn-sm";t.innerHTML='<span class="glyphicon glyphicon-floppy-save"></span> Download CSV';$("body").append(t);t.click();t.remove()}};datamonkey.save_image=function(e,t){var r={xmlns:"http://www.w3.org/2000/xmlns/",xlink:"http://www.w3.org/1999/xlink",svg:"http://www.w3.org/2000/svg"};function n(e){function t(e){try{if(e.cssRules){for(var n=0;n<e.cssRules.length;n++){var a=e.cssRules[n];if(a.type===3){t(a.styleSheet)}else{if(a.selectorText){if(a.selectorText.indexOf(">")===-1){r+="\n"+a.cssText}}}}}}catch(o){console.log("Could not process stylesheet : "+e)}}var r="",n=e.styleSheets;if(n){for(var a=0;a<n.length;a++){t(n[a])}}return r}var a=function(e){var t=document.getElementById("chart-image");t.onload=function(){var e=document.getElementById("chart-canvas");e.width=t.width;e.height=t.height;var r=e.getContext("2d");r.fillStyle="#FFFFFF";r.fillRect(0,0,t.width,t.height);r.drawImage(t,0,0);var n=e.toDataURL("image/png");var a=document.createElement("a");a.setAttribute("download","image.png");a.href=e.toDataURL("image/png");$("body").append(a);a.click();a.remove()};t.src=e};var o=$(t).find("svg")[0];if(!o){o=$(t)[0]}var i=n(window.document);o.setAttribute("version","1.1");var l=document.createElement("defs");o.insertBefore(l,o.firstChild);var s=document.createElement("style");l.appendChild(s);s.setAttribute("type","text/css");o.removeAttribute("xmlns");o.removeAttribute("xlink");if(!o.hasAttributeNS(r.xmlns,"xmlns")){o.setAttributeNS(r.xmlns,"xmlns",r.svg)}if(!o.hasAttributeNS(r.xmlns,"xmlns:xlink")){o.setAttributeNS(r.xmlns,"xmlns:xlink",r.xlink)}var c=(new XMLSerializer).serializeToString(o).replace("</style>","<![CDATA["+i+"]]></style>");var d=o.getBoundingClientRect();var u='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';var f=[u+c];var p="data:image/svg+xml;base66,"+encodeURIComponent(f);if(e=="png"){a(p)}else{var h=document.createElement("a");h.setAttribute("download","image.svg");h.setAttribute("href",p);$("body").append(h);h.click();h.remove()}};datamonkey.jobQueue=function(e){_.templateSettings={evaluate:/\{\%(.+?)\%\}/g,interpolate:/\{\{(.+?)\}\}/g,variable:"rc"};d3.json("/jobqueue",function(t){var r=_.template($("script.job-queue").html());var n=r(t);$("#job-queue-panel").find("table").remove();$(e).append(n)})};datamonkey.status_check=function(){if($(".status-checker").length){var e="/clusterhealth";d3.json(e,function(e){if(e["successful_connection"]){d3.select(".status-checker").classed({"status-healthy":true,"status-troubled":false});$(".status-checker").attr("title","Cluster Status : Healthy")}else{d3.select(".status-checker").classed({"status-healthy":false,"status-troubled":true});$(".status-checker").attr("title","Cluster Status : Troubled; "+e.msg.description)}})}};datamonkey.validate_date=function(){if($(this).val().length==0){$(this).next(".help-block").remove();$(this).parent().removeClass("has-success");$(this).parent().addClass("has-error");jQuery("<span/>",{"class":"help-block",text:"Field is empty"}).insertAfter($(this))}else if(isNaN(Date.parse($(this).val()))){$(this).next(".help-block").remove();$(this).parent().removeClass("has-success");$(this).parent().addClass("has-error");jQuery("<span/>",{"class":"help-block",text:"Date format should be in the format YYYY-mm-dd"}).insertAfter($(this))}else{$(this).parent().removeClass("has-error");$(this).parent().addClass("has-success");$(this).next(".help-block").remove()}};$(document).ready(function(){$(function(){$('[data-toggle="tooltip"]').tooltip()});$("#datamonkey-header").collapse();var e=$("body").css("padding-top");$("#collapse_nav_bar").on("click",function(t){$("#datamonkey-header").collapse("toggle");$(this).find("i").toggleClass("fa-times-circle fa-eye");var r=$("body").css("padding-top")==e?"5px":e;d3.select("body").transition().style("padding-top",r)})});function datamonkey_alignment_viewer(e){var t=this;function r(e){if(!e)e={};t.container=$("div.seq-viewer");t.dataset=[];t.cell_size=30;t.zoom={low:0,high:1};t.dataset=["TREESPARROW_HENAN_1_2004","HUMAN_VIETNAM_CL105_2005","TREESPARROW_HENAN_4_2004","CHICKEN_HEBEI_326_2005","CHICKEN_HONGKONG_915_97","VIETNAM_3062_2004","GOOSE_HONGKONG_W355_97","DUCK_HONGKONG_Y283_97","DUCK_VIETNAM_376_2005","MALLARD_VIETNAM_16_2003","CHICKEN_THAILAND_KANCHANABURI_CK_160_2005","DUCK_GUANGZHOU_20_2005","CK_HK_WF157_2003","SWINE_ANHUI_2004","DUCK_VIETNAM_272_2005","HONGKONG_97_98","GOOSE_SHANTOU_2216_2005","TREESPARROW_HENAN_3_2004","PEREGRINEFALCON_HK_D0028_2004","TREESPARROW_HENAN_2_2004","HONGKONG_538_97"];n()}function n(){var e=$(window).width();var r=$(window).height()-Math.floor($(".navbar").height()*1.1);var n=15;t.paper=d3.selectAll(t.container.selector).append("svg").attr("width",e).attr("height",r);var a={"class":"yAxis",height:r,width:e};t.yAxis=t.paper.append("g").attr(a);t.yAxisLabels=t.yAxis.append("g").attr("class","sequence-labels");var o=t.yAxisLabels.selectAll("sequence-label").data(t.dataset);var i={"class":"sequence-label",y:function(e,r){return r*t.cell_size+n},fill:"#333","dominant-baseline":"central","text-anchor":"right","font-family":'"Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'};o.enter().append("text").attr(i).text(function(e){return e});o.exit().remove();t.xScale=d3.scale.linear().domain([function(){if(d3.min(values)<0){return d3.min(values)}else{return d3.max(values)}}(),(d3.max(values)+maxMean)*t.zoom.high]).range([0,e]);t.xAxis=d3.svg.axis().scale(t.xScale).orient("top");var l={"class":"xAxis header",height:20,width:2e3,transform:"translate("+e+", 0)"};t.xAxisHeader=t.paper.append("g").attr(l);t.xAxisHeader.style("fill","none").call(t.xAxis);t.yScale=d3.scale.ordinal().domain(d3.range(t.dataset.length)).rangeRoundBands([0,r],.25);var s={transform:"translate(0,"+t.yScale(t.dataset.length)+")",fill:"#ccc","font-size":"12px","font-family":'"Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'};t.xAxisHeader.append("g").attr("class","guide_lines_x").call(t.xAxis.tickFormat("").tickSize(-r,0,0));var c={fill:"#000","font-size":12,"font-family":'"Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif'};t.xAxisHeader.selectAll("g.xAxis.header g text").style(c);var d={stroke:"#CCC"};t.xAxisHeader.selectAll("g.guide_lines_x g line").style(d)}r(e);return this}datamonkey.alignment_viewer=datamonkey_alignment_viewer;function datamonkey_cancel(e){$(e).show().next().remove()}function datamonkey_change(e,t){$(t).text(e).show().next().remove()}function datamonkey_check_valid_value(e,t,r){if(e.length){if(e==r){return true}if(t){return!(e in t)}return true}return false}function datamonkey_editable(e,t,r){$(e).hide();if(r){r.filter(function(e){return e[1]}).forEach(function(e){datamonkey_cancel(e[0])});r.forEach(function(t){t[1]=t[0]===e})}var n=d3.select($(e).parent()[0]).append("div").classed("input-group",true);text_field=n.append("input").style("margin-right","1em"),button_ok=n.append("button").classed("btn btn-primary btn-xs",true),button_cancel=n.append("button").classed("btn btn-primary btn-xs",true),current_value=$(e).text();button_ok.append("i").classed("glyphicon glyphicon-ok",true);button_cancel.append("i").classed("glyphicon glyphicon-remove",true);$(text_field[0]).val(current_value).on("input propertychange",function(e){button_ok.property("disabled",!datamonkey_check_valid_value($(this).val(),t,current_value))});button_ok.on("click",function(t,r){datamonkey_change($(text_field[0]).val(),e)});button_cancel.on("click",function(t,r){datamonkey_cancel(e)})}datamonkey.editable=datamonkey_editable;function datamonkey_get_styles(e){var t="",r=e.styleSheets;if(r){for(var n=0;n<r.length;n++){a(r[n])}}function a(e){if(e.cssRules){for(var r=0;r<e.cssRules.length;r++){var n=e.cssRules[r];if(n.type===3){a(n.styleSheet)}else{if(n.selectorText){if(n.selectorText.indexOf(">")===-1){t+="\n"+n.cssText}}}}}}return t}function datamonkey_save_newick_to_file(){var e="#neighbor-tree-modal";var t=$(e).data("tree");var r=document.createElement("a");r.setAttribute("href","data:text/octet-stream;charset=utf-8,"+encodeURIComponent(t));r.setAttribute("download","nwk.txt");$("body").append(r);r.click();r.remove()}function datamonkey_convert_svg_to_png(e){var t=document.getElementById("image");t.src=e;t.onload=function(){var e=document.getElementById("canvas");e.width=t.width;e.height=t.height;var r=e.getContext("2d");r.fillStyle="#FFFFFF";r.fillRect(0,0,t.width,t.height);r.drawImage(t,0,0);var n=e.toDataURL("image/png");var a=document.createElement("a");a.setAttribute("download","phylotree.png");a.href=e.toDataURL("image/png");$("body").append(a);a.click();a.remove()}}function datamonkey_save_newick_tree(e){var t={xmlns:"http://www.w3.org/2000/xmlns/",xlink:"http://www.w3.org/1999/xlink",svg:"http://www.w3.org/2000/svg"};var r="#tree_container";var n=$("#tree_container").find("svg")[0];var a=datamonkey_get_styles(window.document);n.setAttribute("version","1.1");var o=document.createElement("defs");n.insertBefore(o,n.firstChild);var i=document.createElement("style");o.appendChild(i);i.setAttribute("type","text/css");n.removeAttribute("xmlns");n.removeAttribute("xlink");if(!n.hasAttributeNS(t.xmlns,"xmlns")){n.setAttributeNS(t.xmlns,"xmlns",t.svg)}if(!n.hasAttributeNS(t.xmlns,"xmlns:xlink")){n.setAttributeNS(t.xmlns,"xmlns:xlink",t.xlink)}var l=(new XMLSerializer).serializeToString(n).replace("</style>","<![CDATA["+a+"]]></style>");var s=n.getBoundingClientRect();var c='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';var d=[c+l];var u="data:image/svg+xml;base66,"+encodeURIComponent(d);if(e=="png"){datamonkey_convert_svg_to_png(u)}else{var f=document.createElement("a");f.setAttribute("download","phylotree.svg");f.setAttribute("href",u);$("body").append(f);f.click();f.remove()}}function datamonkey_validate_email(e){if($(this).find("input[name='receive_mail']")[0].checked){var t=/^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(t.test($(this).find("input[name='mail']").val())){$(this).removeClass("has-error");$(this).addClass("has-success");$(this).next(".help-block").remove()}else{$(this).next(".help-block").remove();$(this).removeClass("has-error");$(this).removeClass("has-success");$(this).addClass("has-error");var r=jQuery("<span/>",{"class":"help-block col-lg-9 pull-right",text:"Invalid Email"}).insertAfter($(this))}}else{$(this).removeClass("has-error");$(this).removeClass("has-success");$(this).next(".help-block").remove()}}function datamonkey_describe_vector(e,t){e.sort(d3.ascending);var r={min:d3.min(e),max:d3.max(e),median:d3.median(e),Q1:d3.quantile(e,.25),Q3:d3.quantile(e,.75),mean:d3.mean(e)};if(t){r="<pre>Range  :"+r["min"]+"-"+r["max"]+"\n"+"IQR    :"+r["Q1"]+"-"+r["Q3"]+"\n"+"Mean   :"+r["mean"]+"\n"+"Median :"+r["median"]+"\n"+"</pre>"}return r}function datamonkey_export_handler(e,t,r){var n=$("body").add("a");n.attr("download",t||"download.tsv").attr("href","data:"+(r||"text/plain")+";charset=utf-8,"+encodeURIComponent(e)).click().detach()}function datamonkey_table_to_text(e,t){t=t||"	";var r=[];d3.select(e+" thead").selectAll("th").each(function(){r.push(d3.select(this).text())});var n=[];d3.select(e+" tbody").selectAll("tr").each(function(e,t){n.push([]);d3.select(this).selectAll("td").each(function(){n[t].push(d3.select(this).text())})});return r.join(t)+"\n"+n.map(function(e){return e.join(t)}).join("\n")}function datamonkey_capitalize(e){if(e.length>0){return e[0].toUpperCase()+e.slice(1)}else{return e}}datamonkey.helpers=new Object;datamonkey.helpers.save_newick_to_file=datamonkey_save_newick_to_file;datamonkey.helpers.convert_svg_to_png=datamonkey_convert_svg_to_png;datamonkey.helpers.save_newick_tree=datamonkey_save_newick_tree;datamonkey.helpers.validate_email=datamonkey_validate_email;datamonkey.helpers.describe_vector=datamonkey_describe_vector;datamonkey.helpers.table_to_text=datamonkey_table_to_text;datamonkey.helpers.export_handler=datamonkey_export_handler;datamonkey.helpers.capitalize=datamonkey_capitalize;function set_tree_handlers(e){$("[data-direction]").on("click",function(t){var r=$(this).data("direction")=="vertical"?e.spacing_x:e.spacing_y;r(r()+ +$(this).data("amount")).update()});$(".phylotree-layout-mode").on("change",function(t){if($(this).is(":checked")){if(e.radial()!=($(this).data("mode")=="radial")){e.radial(!e.radial()).placenodes().update()}}});$(".phylotree-align-toggler").on("change",function(t){if($(this).is(":checked")){if(e.align_tips($(this).data("align")=="right")){e.placenodes().update()}}});$("#sort_original").on("click",function(t){e.resort_children(function(e,t){return e["original_child_order"]-t["original_child_order"]});t.preventDefault()});$("#sort_ascending").on("click",function(e){t(true);e.preventDefault()});$("#sort_descending").on("click",function(e){t(false);e.preventDefault()});function t(t){e.traverse_and_compute(function(e){var t=1;if(e.children&&e.children.length){t+=d3.max(e.children,function(e){return e["count_depth"]})}e["count_depth"]=t});e.resort_children(function(e,r){return(e["count_depth"]-r["count_depth"])*(t?1:-1)})}}var root=this;if(!datamonkey){datamonkey=function(){}}datamonkey.busted=function(){};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=datamonkey.busted}exports.datamonkey.busted=datamonkey.busted}else{root.datamonkey.busted=datamonkey.busted}function busted_render_summary(e){var t=d3.format(".2f"),r=d3.format(".2p"),n=d3.format(".3r");var a=function(e){var t="";e=parseFloat(e);var r=[Math.floor(e/(24*3600)),Math.floor(e/3600)%24,Math.floor(e/60)%60,e%60],n=["d.","hrs.","min.","sec."];r.forEach(function(e,r){if(e){t+=" "+e+" "+n[r]}});return t};var o={};var i={},l=0,s=0,c=0;var d=[];for(var u in e["test results"]){o[u]=e["test results"]["p"];if(o[u]<=.05){s++}}var f=e["fits"]["Unconstrained model"]["rate distributions"];for(var p in f){try{d[l][2]=e["test results"][p]["LRT"];d[l][3]=e["test results"][p]["p"];d[l][4]=e["test results"][p]["uncorrected p"]}catch(h){}var m=f[p];i[p]=m;l+=1}var g=d3.format("g")(e["fits"]["Unconstrained model"]["tree length"]);d=d.sort(function(e,t){return e[4]-t[4]});d3.select("#summary-test-result").text(e["test results"]["p"]<=.05?"evidence":"no evidence");d3.select("#summary-test-pvalue").text(d3.format(".3f")(e["test results"]["p"]));d3.select("#summary-pmid").text("PubMed ID "+e["PMID"]).attr("href","http://www.ncbi.nlm.nih.gov/pubmed/"+e["PMID"]);d3.select("#summary-total-runtime").text(a(e["timers"]["overall"]));d3.select("#summary-total-branches").text(l);d3.select("#summary-tested-branches").text(c);d3.select("#summary-selected-branches").text(s);has_background=e["background"];var v=[[],[]];if(has_background){v.push([])}for(k=0;k<2+has_background;k++){var _,y,b=0;if(k==0){_="Unconstrained model";y="FG";v[k].push("Unconstrained Model");b=0}else{if(has_background&&k==1){v[k].push("(background branches)");y="BG";b=1}else{_="Constrained model";if(!(_ in e["fits"])){break}v[k].push("Constrained Model");y="FG";b=0}}try{v[k].push(b?"":t(e["fits"][_]["log-likelihood"]));v[k].push(b?"":e["fits"][_]["parameters"]);v[k].push(b?"":t(e["fits"][_]["AIC-c"]));v[k].push(b?"":a(e["fits"][_]["runtime"]));v[k].push(b?"":t(e["fits"][_]["tree length"]));for(j=0;j<3;j++){v[k].push(n(e["fits"][_]["rate distributions"][y][j][0])+" ("+r(e["fits"][_]["rate distributions"][y][j][1])+")")}}catch(h){datamonkey.errorModal(h)}}v=d3.select("#summary-model-table").selectAll("tr").data(v);v.enter().append("tr");v.exit().remove();v=v.selectAll("td").data(function(e){return e});v.enter().append("td");v.html(function(e){return e})}datamonkey.busted.render_summary=busted_render_summary;var root=this;datamonkey.hivtrace=function(){};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=datamonkey.hivtrace}exports.datamonkey.hivtrace=datamonkey.hivtrace}else{root.datamonkey.hivtrace=datamonkey.hivtrace}if(!datamonkey){var datamonkey=new Object}datamonkey.absrel=function(){var e=800,t=600,r=d3.scale.category10(),n={},a={},o=.05,i=d3.format(".3r"),l=d3.format(".2p"),s=d3.format(".2f"),c=d3.format(".4f"),u=true,f="Full model",p="color_legend",h=this,m="tree_container";h.tree=d3.layout.phylotree("body").size([t,e]).separation(function(e,t){return 0});h.analysis_data=null;h.svg=d3.select("#"+m).append("svg").attr("width",e).attr("height",t);var g=.33;var v=d3.scale.pow().exponent(g).domain([0,.25,1,5,10]).range(["#5e4fa2","#3288bd","#e6f598","#f46d43","#9e0142"]).clamp(true);set_tree_handlers(h.tree);$("#datamonkey-absrel-color-or-grey").on("click",function(e){if($(h).data("color-mode")=="gray"){$(h).data("color-mode","color");v.range(["#5e4fa2","#3288bd","#e6f598","#f46d43","#9e0142"])}else{$(h).data("color-mode","gray");v.range(["#EEE","#BBB","#999","#333","#000"])}n=z(h.analysis_data,f)[1];h.tree.update();y(p)});$("#datamonkey-absrel-show-color-bar").on("click",function(e){u=!u;if($(h).data("color-bar")=="on"){$(h).data("color-mode","off")}else{$(h).data("color-mode","on")}y(p)});$("#datamonkey-absrel-show-model").on("click",function(e){if($(h).data("model")=="MG94"){$(h).data("model","Full model")}else{$(h).data("model","MG94")}f=$(h).data("model");n=z(h.analysis_data,f)[1];h.tree.layout()});function _(){h.tree.branch_length(null);h.tree.branch_name(null);h.tree.node_span("equal");h.tree.options({"draw-size-bubbles":false,selectable:false,transitions:false},false);h.tree.font_size(18);h.tree.scale_bar_font_size(14);h.tree.node_circle_size(0);h.tree.spacing_x(35,true);h.tree.style_edges(A)}function y(e){var t=d3.select("#"+e).selectAll("svg").data([v.domain()]);t.enter().append("svg");t.selectAll("*").remove();if(u){var r=70,n=300,a={bottom:30,top:15,left:40,right:2};t.attr("width",r).attr("height",n);this_grad=t.append("defs").append("linearGradient").attr("id","_omega_bar").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");var o=d3.scale.pow().exponent(g).domain(d3.extent(v.domain())).range([0,1]),i=d3.scale.pow().exponent(g).domain(d3.extent(v.domain())).range([0,n-a["top"]-a["bottom"]]);v.domain().forEach(function(e){this_grad.append("stop").attr("offset",""+o(e)*100+"%").style("stop-color",v(e))});var l=t.append("g").attr("transform","translate("+a["left"]+","+a["top"]+")");l.append("rect").attr("x",0).attr("width",r-a["left"]-a["right"]).attr("y",0).attr("height",n-a["top"]-a["bottom"]).style("fill","url(#_omega_bar)");var s=d3.svg.axis().scale(i).orient("left").tickFormat(d3.format(".1r")).tickValues([0,.01,.1,.5,1,2,5,10]);var c=l.append("g");c.style("font-size","14").attr("class","omega-bar").call(s);c.selectAll("text").style("text-anchor","right");var d=_label=c.append("g").attr("class","omega-bar");d=d.selectAll("text").data(["ω"]);d.enter().append("text");d.text(function(e){return e}).attr("transform","translate("+(r-a["left"]-a["right"])*.5+","+(n-a["bottom"])+")").style("text-anchor","middle").style("font-size","18").attr("dx","0.0em").attr("dy","0.1em")}}function b(e){$("#datamonkey-absrel-error-hide").on("click",function(e){d3.select("#datamonkey-absrel-error").style("display","none");e.preventDefault()});d3.select("#datamonkey-absrel-error-text").text(e);d3.select("#datamonkey-absrel-error").style("display","block")}function x(e,t){var r=[],n=t.reduce(function(e,t){return e+t},0),a=0;for(var o=0;o<e.length;o++){if(e[o]==null||t[o]==null){return}var i={omega:e[o],weight:t[o]/n};r.push(i)}return r}function w(e,t,r,n){var a=n["svg"]||"primary_omega_plot",o=n["tag"]||"primary_omega_tag";var i=n["legend"]||null;var l=n["log"]||false;var s=n["dimensions"]||{width:600,height:400};var c={left:50,right:15,bottom:35,top:35},d=s["width"]-c["left"]-c["right"],u=s["height"]-c["top"]-c["bottom"];var f=n["k"]||null;var p=n["domain"]||d3.extent(t);var h=(l?d3.scale.log():d3.scale.linear()).range([0,d]).domain(p).nice().clamp(true),m=d3.scale.linear().range([u,0]).domain([0,1]);var g=x(t,r);d3.select("#"+o).text(e);var _=d3.select("#"+a).attr("width",s.width).attr("height",s.height),y=_.selectAll(".container");if(y.empty()){y=_.append("g").attr("class","container")}y.attr("transform","translate("+c["left"]+" , "+c["top"]+")");var b=y.selectAll(".omega-line").data(g);b.enter().append("line");b.exit().remove();b.transition().attr("x1",function(e){return h(e.omega)}).attr("x2",function(e){return h(e.omega)}).attr("y1",function(e){return m(0)}).attr("y2",function(e){return m(e.weight)}).style("stroke",function(e){return v(e.omega)}).attr("class","omega-line");var k=y.selectAll(".neutral-line").data([1]);k.enter().append("line").attr("class","neutral-line");k.exit().remove();k.transition().attr("x1",function(e){return h(e)}).attr("x2",function(e){return h(e)}).attr("y1",0).attr("y2",u);var w=d3.svg.axis().scale(h).orient("bottom");if(l){w.ticks(10,".1r")}var A=_.selectAll(".x.axis");var $;if(A.empty()){A=_.append("g").attr("class","x axis");$=A.append("g").attr("class","axis-label x-label")}else{$=A.select(".axis-label.x-label")}A.attr("transform","translate("+c["left"]+","+(u+c["top"])+")").call(w);$=$.attr("transform","translate("+d+","+c["bottom"]+")").selectAll("text").data(["ω"]);$.enter().append("text");$.text(function(e){return e}).style("text-anchor","end").attr("dy","0.0em");var E=d3.svg.axis().scale(m).orient("left").ticks(10,".1p");var z=_.selectAll(".y.axis");var D;if(z.empty()){z=_.append("g").attr("class","y axis");D=z.append("g").attr("class","axis-label y-label")}else{D=z.select(".axis-label.y-label")}z.attr("transform","translate("+c["left"]+","+c["top"]+")").call(E);D=D.attr("transform","translate("+-c["left"]+","+0+")").selectAll("text").data(["Proportion of sites"]);D.enter().append("text");D.text(function(e){return e}).style("text-anchor","start").attr("dy","-1em")}function A(e,t){var r=n[t.target.name];if(r){if("color"in r){e.style("stroke",r["color"])}else{e.style("stroke","url(#"+r["grad"]+")");if(h.tree.radial()){d3.select("#"+r["grad"]).attr("gradientTransform","rotate("+t.target.angle+")")}else{d3.select("#"+r["grad"]).attr("gradientTransform",null)}}$(e[0][0]).tooltip({title:r["tooltip"],html:true,trigger:"hover",container:"body",placement:"auto"})}e.style("stroke-width",a[t.target.name]<=o?"12":"5").style("stroke-linejoin","round").style("stroke-linecap","round")}function E(e,t,r,n){var a=e.append("linearGradient").attr("id",t);var o=0;r.forEach(function(e,t){if(e[1]){var r=o+e[1];a.append("stop").attr("offset",""+o*100+"%").style("stop-color",v(e[0]));a.append("stop").attr("offset",""+r*100+"%").style("stop-color",v(e[0]));o=r}})}function z(e,t){h.tree(e["fits"][t]["tree string"]).svg(h.svg);var r=h.svg.selectAll("defs");if(r.empty()){r=h.svg.append("defs")}r.selectAll("*").remove();gradID=0;var n={};var a=e["fits"][t]["rate distributions"];for(var o in a){a[o]=a[o].replace(/inf/g,"1e+9999");a[o]=a[o].replace(/-nan/g,"null");a[o]=a[o].replace(/nan/g,"null");var s=JSON.parse(a[o]);if(s.length==1){n[o]={color:v(s[0][0])}}else{gradID++;var c="branch_gradient_"+gradID;E(r,c,s);n[o]={grad:c}}n[o]["omegas"]=s;n[o]["tooltip"]="<b>"+o+"</b>";n[o]["distro"]="";s.forEach(function(e,t){var r=e[0]>1e20?"&infin;":i(e[0]),a=l(e[1]);n[o]["tooltip"]+="<br/>&omega;<sub>"+(t+1)+"</sub> = "+r+" ("+a+")";if(t){n[o]["distro"]+="<br/>"}n[o]["distro"]+="&omega;<sub>"+(t+1)+"</sub> = "+r+" ("+a+")"});n[o]["tooltip"]+="<br/><i>p = "+i(e["test results"][o]["p"])+"</i>"}h.tree.style_edges(function(e,t){A(e,t)});branch_lengths={};h.tree.get_nodes().forEach(function(e){if(e.parent){branch_lengths[e.name]=h.tree.branch_length()(e)}});return[branch_lengths,n]}var D=function(e){try{d3.select("#datamonkey-absrel-error").style("display","none");h.analysis_data=e;function t(e){if(Object.keys(r).indexOf(e[0])!=-1){w(e[0],r[e[0]].map(function(e){return e[0]}),r[e[0]].map(function(e){return e[1]}),{log:true,legend:false,domain:[1e-5,10],dimensions:{width:400,height:400}})}}_();a={};var r={},o=0,i=0,u=0;var f=[];var m=z(e,"Full model");var g=m[0],v={};n=m[1];for(var x in e["test results"]){a[x]=e["test results"][x]["p"];if(a[x]<=.05){i++}if(e["test results"][x]["tested"]>0){v[x]=true;u+=1}}var A=e["fits"]["Full model"]["rate distributions"];for(var $ in A){f.push([$+(v[$]?"":" (not tested)"),g[$],0,0,0]);try{f[o][2]=e["test results"][$]["LRT"];f[o][3]=e["test results"][$]["p"];f[o][4]=e["test results"][$]["uncorrected p"]}catch(E){}var D=JSON.parse(A[$]);r[$]=D;f[o].push(n[$]["distro"]);o+=1}y(p);var N=e["fits"]["Full model"]["tree length"];f=f.sort(function(e,t){return e[4]-t[4]});t(f[0]);f=d3.select("#table-branch-table").selectAll("tr").data(f);f.enter().append("tr");f.exit().remove();f.style("font-weight",function(e){return e[3]<=.05?"bold":"normal"});f.on("click",function(e){t(e)});f=f.selectAll("td").data(function(e){return e});f.enter().append("td");f.html(function(e){if(typeof e=="number"){return c(e)}return e});d3.select("#summary-method-name").text(e["version"]);d3.select("#summary-pmid").text("PubMed ID "+e["PMID"]).attr("href","http://www.ncbi.nlm.nih.gov/pubmed/"+e["PMID"]);d3.select("#summary-total-runtime").text(C(e["timers"]["overall"]));d3.select("#summary-complexity-runtime").text(C(e["timers"]["overall"]));d3.select("#summary-complexity-runtime").text(C(e["timers"]["Complexity analysis"]));d3.select("#summary-testing-runtime").text(C(e["timers"]["Testing"]));d3.select("#summary-total-branches").text(o);d3.select("#summary-tested-branches").text(u);d3.select("#summary-selected-branches").text(i);var I=[[],[]];for(k=0;k<2;k++){var M;if(k==0){M="MG94";I[k].push("Branch-wise &omega; variation (MG94)")}else{M="Full model";I[k].push("Branch-site &omega; variation")}I[k].push(s(e["fits"][M]["log-likelihood"]));I[k].push(e["fits"][M]["parameters"]);I[k].push(s(e["fits"][M]["AIC-c"]));I[k].push(C(e["fits"][M]["runtime"]))}I=d3.select("#summary-model-table").selectAll("tr").data(I);I.enter().append("tr");I.exit().remove();I=I.selectAll("td").data(function(e){return e});I.enter().append("td");I.html(function(e){return e});d3.select("#summary-tree-length").text(s(e["fits"]["Full model"]["tree length"]));d3.select("#summary-tree-length-mg94").text(s(e["fits"]["MG94"]["tree length"]));var F={};h.tree.get_nodes().forEach(function(t){if(t.parent){var n=r[t.name].length;if(!(n in F)){F[n]=[n,0,0,0]}F[n][1]++;F[n][2]+=h.tree.branch_length()(t);if(e["test results"][t.name]["p"]<=.05){F[n][3]++}}});var S=[];for(k in F){d=F[k];S.push([d[0],d[1],l(d[1]/o),l(d[2]/N),d[3]])}S=S.sort(function(e,t){return e[0]-t[0]});S=d3.select("#summary-tree-table").selectAll("tr").data(S);S.enter().append("tr");S.exit().remove();S=S.selectAll("td").data(function(e){return e});S.enter().append("td");S.html(function(e){return e});h.tree.layout()}catch(E){b(E.message)}};function C(e){var t="";e=parseFloat(e);var r=[Math.floor(e/(24*3600)),Math.floor(e/3600)%24,Math.floor(e/60)%60,e%60],n=["d.","hrs.","min.","sec."];r.forEach(function(e,r){if(e){t+=" "+e+" "+n[r]}});return t}return D};function busted_draw_distribution(e,t,r,n){var a=function(e,t){var r=[],n=t.reduce(function(e,t){return e+t},0),a=0;for(var o=0;o<e.length;o++){if(e[o]==null||t[o]==null){return}var i={omega:e[o],weight:t[o]/n};r.push(i)}return r};var o=n["svg"]||"primary-omega-plot",i=n["tag"]||"primary-omega-tag";var l=n["legend"]||null;var s=n["log"]||false;var c=n["dimensions"]||{width:300,height:200};var d={left:50,right:15,bottom:35,top:35},u=c["width"]-d["left"]-d["right"],f=c["height"]-d["top"]-d["bottom"];var p=n["k"]||null;var h=n["domain"]||d3.extent(t);var m=(s?d3.scale.log():d3.scale.linear()).range([0,u]).domain(h).nice().clamp(true),g=d3.scale.linear().range([f,0]).domain([0,1]);var v=a(t,r);d3.select("#"+i).text(e);var _=d3.select("#"+o).attr("width",c.width).attr("height",c.height),y=_.selectAll(".container");if(y.empty()){y=_.append("g").attr("class","container")}y.attr("transform","translate("+d["left"]+" , "+d["top"]+")");var b=.33;var x=d3.scale.pow().exponent(b).domain([0,.25,1,5,10]).range(["#5e4fa2","#3288bd","#e6f598","#f46d43","#9e0142"]).clamp(true);var k=y.selectAll(".omega-line").data(v);k.enter().append("line");k.exit().remove();k.transition().attr("x1",function(e){return m(e.omega)}).attr("x2",function(e){return m(e.omega)}).attr("y1",function(e){return g(0)}).attr("y2",function(e){return g(e.weight)}).style("stroke",function(e){return x(e.omega)}).attr("class","omega-line");var w=y.selectAll(".neutral-line").data([1]);w.enter().append("line").attr("class","neutral-line");w.exit().remove();w.transition().attr("x1",function(e){return m(e)}).attr("x2",function(e){return m(e)}).attr("y1",0).attr("y2",f);var A=d3.svg.axis().scale(m).orient("bottom");if(s){A.ticks(10,".1r")}var $=_.selectAll(".x.axis");var E;if($.empty()){$=_.append("g").attr("class","x axis");E=$.append("g").attr("class","axis-label x-label")}else{E=$.select(".axis-label.x-label")}$.attr("transform","translate("+d["left"]+","+(f+d["top"])+")").call(A);E=E.attr("transform","translate("+u+","+d["bottom"]+")").selectAll("text").data(["ω"]);E.enter().append("text");E.text(function(e){return e}).style("text-anchor","end").attr("dy","0.0em");var z=d3.svg.axis().scale(g).orient("left").ticks(10,".1p");var D=_.selectAll(".y.axis");var C;if(D.empty()){D=_.append("g").attr("class","y axis");C=D.append("g").attr("class","axis-label y-label")}else{C=D.select(".axis-label.y-label")}D.attr("transform","translate("+d["left"]+","+d["top"]+")").call(z);C=C.attr("transform","translate("+-d["left"]+","+0+")").selectAll("text").data(["Proportion of sites"]);C.enter().append("text");C.text(function(e){return e}).style("text-anchor","start").attr("dy","-1em")}datamonkey.busted.draw_distribution=busted_draw_distribution;function busted_render_histogram(e,t){var r=this;if(d3.keys(t["evidence ratios"]).length==0){d3.selectAll(e).style("display","none");d3.selectAll(".dc-data-table").style("display","none");d3.selectAll('[id^="export"]').style("display","none");d3.selectAll("#er-thresholds").style("display","none");d3.selectAll("#apply-thresholds").style("display","none");return}else{d3.selectAll(e).style("display","block");d3.selectAll(".dc-data-table").style("display","table");d3.selectAll('[id^="export"]').style("display","block");d3.selectAll("#er-thresholds").style("display","block");d3.selectAll("#apply-thresholds").style("display","block")}var n=t["evidence ratios"]["constrained"][0];n=n.map(function(e){return Math.log(e)});var a=t["test set"].split(",");var o=[];n.forEach(function(e,r){o.push({site_index:r+1,unconstrained:t["profiles"]["unconstrained"][0][r],constrained:t["profiles"]["constrained"][0][r],optimized_null:t["profiles"]["optimized null"][0][r],er_constrained:Math.log(t["evidence ratios"]["constrained"][0][r]),er_optimized_null:Math.log(t["evidence ratios"]["optimized null"][0][r])})});var i=crossfilter(o);var l=i.dimension(function(e){return e["site_index"]});var s=l.group().reduce(function(e,t){e.constrained_evidence+=+t["er_constrained"];e.optimized_null_evidence+=+t["er_optimized_null"];return e},function(e,t){e.constrained_evidence-=+t["er_constrained"];e.optimized_null_evidence-=+t["er_optimized_null"];return e},function(){return{constrained_evidence:0,optimized_null_evidence:0}});var c=l.group().reduce(function(e,t){e.optimized_null_evidence+=+t["er_optimized_null"];return e},function(e,t){e.optimized_null_evidence-=+t["er_optimized_null"];return e},function(){return{optimized_null_evidence:0
}});var d=i.dimension(function(e){return e["er_constrained"]});var u=i.dimension(function(e){return e["er_optimized_null"]});r.er_constrained=d;r.er_optimized_null=u;var f=dc.compositeChart(e);f.width(1170).height(300).dimension(l).x(d3.scale.linear().domain([1,n.length])).yAxisLabel("2 * Ln Evidence Ratio").xAxisLabel("Site Location").legend(dc.legend().x(1020).y(20).itemHeight(13).gap(5)).renderHorizontalGridLines(true).compose([dc.lineChart(f).group(s,"Constrained").colors(d3.scale.ordinal().range(["green"])).valueAccessor(function(e){return 2*e.value.constrained_evidence}).keyAccessor(function(e){return e.key}),dc.lineChart(f).group(c,"Optimized Null").valueAccessor(function(e){return 2*e.value.optimized_null_evidence}).keyAccessor(function(e){return e.key}).colors(d3.scale.ordinal().range(["red"]))]);f.xAxis().ticks(50);var p=d3.format(".4f");dc.dataTable(".dc-data-table").dimension(l).group(function(e){return l.bottom(1)[0].site_index+" - "+l.top(1)[0].site_index}).size(l.groupAll().reduceCount().value()).columns([function(e){return e.site_index},function(e){return p(e["unconstrained"])},function(e){return p(e["constrained"])},function(e){return p(e["optimized_null"])},function(e){return p(e["er_constrained"])},function(e){return p(e["er_optimized_null"])}]).sortBy(function(e){return e.site_index}).order(d3.ascending).renderlet(function(e){e.selectAll(".dc-table-group").classed("info",true)});$("#export-csv").on("click",function(e){datamonkey.export_csv_button(l.top(Infinity))});$("#export-chart-svg").on("click",function(e){$("#chart-id").find("svg")[0].setAttribute("class","dc-chart");datamonkey.save_image("svg","#chart-id");$("#chart-id").find("svg")[0].setAttribute("class","")});$("#export-chart-png").on("click",function(e){$("#chart-id").find("svg")[0].setAttribute("class","dc-chart");datamonkey.save_image("png","#chart-id");$("#chart-id").find("svg")[0].setAttribute("class","")});$("#apply-thresholds").on("click",function(e){var t=document.getElementById("er-constrained-threshold").value;var n=document.getElementById("er-optimized-null-threshold").value;r.er_constrained.filter(function(e){return e>=t});r.er_optimized_null.filter(function(e){return e>=n});dc.renderAll()});dc.renderAll()}datamonkey.busted.render_histogram=busted_render_histogram;function busted_render_tree(e,t,r){var n=600,a=600,o=d3.scale.category10(),i={},l={},s=.05,c=d3.format(".3r"),d=d3.format(".2p"),u=d3.format(".4f"),f=null,p=true,h="Constrained model",m="color_legend";var g=d3.layout.phylotree(t).size([a,n]).separation(function(e,t){return 0});var v=d3.select(e).append("svg").attr("width",n).attr("height",a);var _=.33;var y=d3.scale.pow().exponent(_).domain([0,.25,1,5,10]).range(["#5e4fa2","#3288bd","#e6f598","#f46d43","#9e0142"]).clamp(true);$("#expand_spacing").on("click",function(e){g.spacing_x(g.spacing_x()+1).update(true)});$("#compress_spacing").on("click",function(e){g.spacing_x(g.spacing_x()-1).update(true)});$("#color_or_grey").on("click",function(e){if($(this).data("color-mode")=="gray"){$(this).data("color-mode","color");d3.select(this).text("Use grayscale");y.range(["#5e4fa2","#3288bd","#e6f598","#f46d43","#9e0142"])}else{$(this).data("color-mode","gray");d3.select(this).text("Use color");y.range(["#EEE","#BBB","#999","#333","#000"])}i=x(f,h)[1];g.update();e.preventDefault()});$("#show_color_bar").on("click",function(e){p=!p;if($(this).data("color-bar")=="on"){$(this).data("color-mode","off");d3.select(this).html("Show &omega; color legend")}else{$(this).data("color-mode","on");d3.select(this).html("Hide &omega; color legend")}b(m);e.preventDefault()});$("#show_model").on("click",function(e){if($(this).data("model")=="Unconstrained"){$(this).data("model","Unconstrained model");d3.select(this).html("Show Unconstrained model Model")}else{$(this).data("model","Constrained model");d3.select(this).html("Show Branch-site Model")}h=$(this).data("model");i=x(f,h)[1];g.layout();e.preventDefault()});function b(e){console.log(y);var t=d3.select("#"+e).selectAll("svg").data([y.domain()]);t.enter().append("svg");t.selectAll("*").remove();if(p){var r=70,n=300,a={bottom:30,top:15,left:40,right:2};t.attr("width",r).attr("height",n);this_grad=t.append("defs").append("linearGradient").attr("id","_omega_bar").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");var o=d3.scale.pow().exponent(_).domain(d3.extent(y.domain())).range([0,1]),i=d3.scale.pow().exponent(_).domain(d3.extent(y.domain())).range([0,n-a["top"]-a["bottom"]]);y.domain().forEach(function(e){this_grad.append("stop").attr("offset",""+o(e)*100+"%").style("stop-color",y(e))});var l=t.append("g").attr("transform","translate("+a["left"]+","+a["top"]+")");l.append("rect").attr("x",0).attr("width",r-a["left"]-a["right"]).attr("y",0).attr("height",n-a["top"]-a["bottom"]).style("fill","url(#_omega_bar)");var s=d3.svg.axis().scale(i).orient("left").tickFormat(d3.format(".1r")).tickValues([0,.01,.1,.5,1,2,5,10]);var c=l.append("g");c.style("font-size","14").attr("class","omega-bar").call(s);c.selectAll("text").style("text-anchor","right");var d=_label=c.append("g").attr("class","omega-bar");d=d.selectAll("text").data(["ω"]);d.enter().append("text");d.text(function(e){return e}).attr("transform","translate("+(r-a["left"]-a["right"])*.5+","+(n-a["bottom"])+")").style("text-anchor","middle").style("font-size","18").attr("dx","0.0em").attr("dy","0.1em")}}function x(e,t){g(e["fits"][t]["tree string"]).svg(v);var r=v.selectAll("defs");if(r.empty()){r=v.append("defs")}r.selectAll("*").remove();gradID=0;var n={};var a=e["fits"][t]["rate distributions"];for(var o in a){var i=a[o];if(i.length==1){n[o]={color:y(i[0][0])}}else{gradID++;var l="branch_gradient_"+gradID;n[o]={grad:l}}n[o]["omegas"]=i;n[o]["tooltip"]="<b>"+o+"</b>";n[o]["distro"]="";i.forEach(function(e,t){var r=e[0]>1e20?"&infin;":c(e[0]),a=d(e[1]);n[o]["tooltip"]+="<br/>&omega;<sub>"+(t+1)+"</sub> = "+r+" ("+a+")";if(t){n[o]["distro"]+="<br/>"}n[o]["distro"]+="&omega;<sub>"+(t+1)+"</sub> = "+r+" ("+a+")"});n[o]["tooltip"]+="<br/><i>p = "+c(e["test results"]["p"])+"</i>"}g.style_edges(function(e,t){k(e,t)});branch_lengths={};g.get_nodes().forEach(function(e){if(e.parent){branch_lengths[e.name]=g.branch_length()(e)}});g.layout();return[branch_lengths,n]}function k(e,t){var r=i[t.target.name];if(r){if("color"in r){e.style("stroke",r["color"])}else{e.style("stroke","url(#"+r["grad"]+")")}$(e[0][0]).tooltip({title:r["tooltip"],html:true,trigger:"hover",container:"body",placement:"auto"})}var n=false;if(global_test_set.indexOf(t.target.name)!=-1){n=true}e.style("stroke-width",l[t.target.name]<=s?"12":"5").style("stroke",n?"red":"gray").style("stroke-linejoin","round").style("stroke-linejoin","round").style("stroke-linecap","round")}$("#export-phylo-png").on("click",function(e){datamonkey.save_image("png","#tree_container")});$("#export-phylo-svg").on("click",function(e){datamonkey.save_image("svg","#tree_container")});g.branch_length(null);g.branch_name(null);g.node_span("equal");g.options({"draw-size-bubbles":false},false);g.options({selectable:false},false);g.font_size(18);g.scale_bar_font_size(14);g.node_circle_size(6);g.spacing_x(35,true);g.style_edges(k);x(r,"Unconstrained model")}datamonkey.busted.render_tree=busted_render_tree;function getStyles(e){function t(e){if(e.cssRules){for(var n=0;n<e.cssRules.length;n++){var a=e.cssRules[n];if(a.type===3){t(a.styleSheet)}else{if(a.selectorText){if(a.selectorText.indexOf(">")===-1){r+="\n"+a.cssText}}}}}}var r="",n=e.styleSheets;if(n){for(var a=0;a<n.length;a++){t(n[a])}}return r}function exportCSVButton(e){e=d3.csv.format(e);if(e!=null){var t=document.createElement("a");t.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(e));t.setAttribute("download","export.csv");t.className="btn btn-default btn-sm";t.innerHTML='<span class="glyphicon glyphicon-floppy-save"></span> Download CSV';$("body").append(t);t.click();t.remove()}}function convertSVGtoPNG(e){var t=document.getElementById("chart-image");t.src=e;t.onload=function(){var e=document.getElementById("chart-canvas");e.width=t.width;e.height=t.height;var r=e.getContext("2d");r.fillStyle="#FFFFFF";r.fillRect(0,0,t.width,t.height);r.drawImage(t,0,0);var n=e.toDataURL("image/png");var a=document.createElement("a");a.setAttribute("download","image.png");a.href=e.toDataURL("image/png");$("body").append(a);a.click();a.remove()}}function saveImage(e,t){var r={xmlns:"http://www.w3.org/2000/xmlns/",xlink:"http://www.w3.org/1999/xlink",svg:"http://www.w3.org/2000/svg"};var n=$(t).find("svg")[0];var a=getStyles(window.document);n.setAttribute("version","1.1");var o=document.createElement("defs");n.insertBefore(o,n.firstChild);var i=document.createElement("style");o.appendChild(i);i.setAttribute("type","text/css");n.removeAttribute("xmlns");n.removeAttribute("xlink");if(!n.hasAttributeNS(r.xmlns,"xmlns")){n.setAttributeNS(r.xmlns,"xmlns",r.svg)}if(!n.hasAttributeNS(r.xmlns,"xmlns:xlink")){n.setAttributeNS(r.xmlns,"xmlns:xlink",r.xlink)}var l=(new XMLSerializer).serializeToString(n).replace("</style>","<![CDATA["+a+"]]></style>");var s=n.getBoundingClientRect();var c='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';var d=[c+l];var u="data:image/svg+xml;base66,"+encodeURIComponent(d);if(e=="png"){convertSVGtoPNG(u)}else{var f=document.createElement("a");f.setAttribute("download","image.svg");f.setAttribute("href",u);$("body").append(f);f.click();f.remove()}}var _networkGraphAttrbuteID="user attributes";var _defaultFloatFormat=d3.format(",.2r");var hivtrace_cluster_network_graph=function(e,t,r,n,a,o,l,s,c,d){var u=new Object;u.ww=d3.select(d).property("clientWidth");u.nodes=[];u.edges=[];u.clusters=[];u.cluster_sizes=[];u.colorizer={selected:function(e){return e=="selected"?d3.rgb(51,122,183):"#FFF"}};u.filter_edges=true,u.hide_hxb2=false,u.charge_correction=1,u.margin={top:20,right:10,bottom:30,left:10},u.width=u.ww-u.margin.left-u.margin.right,u.height=500-u.margin.top-u.margin.bottom,u.cluster_table=d3.select(s),u.node_table=d3.select(c),u.needs_an_update=false,u.json=e;var f={},p=5e3,h=u.json,m=500,g="",v=0,y=[],b;var x=d3.layout.force().on("tick",q).charge(function(e){if(e.cluster_id)return u.charge_correction*(-50-20*Math.pow(e.children.length,.7));return u.charge_correction*(-20*Math.sqrt(e.degree))}).linkDistance(function(e){return Math.max(e.length*p,1)}).linkStrength(function(e){if(e.support!=undefined){return 2*(.5-e.support)}return 1}).chargeDistance(500).friction(.25);d3.select(t).selectAll(".my_progress").remove();var w=d3.select(t).append("svg:svg").style("border","solid black 1px").attr("id","network-svg").attr("width",u.width+u.margin.left+u.margin.right).attr("height",u.height+u.margin.top+u.margin.bottom);w.append("defs").append("marker").attr("id","arrowhead").attr("refX",9).attr("refY",2).attr("markerWidth",6).attr("markerHeight",4).attr("orient","auto").attr("stroke","#666666").attr("fill","#AAAAAA").append("path").attr("d","M 0,0 V 4 L6,2 Z");I();var A=function(e,r){var n=d3.select(t);var a="d3_context_menu_id";var o=n.select("#"+a);if(o.empty()){o=n.append("ul").attr("id",a).attr("class","dropdown-menu").attr("role","menu")}o.selectAll("li").remove();var i=e&&e.fixed==1;if(e){o.append("li").append("a").attr("tabindex","-1").text("Expand cluster").on("click",function(t){e.fixed=0;ge(e,true);o.style("display","none")});o.append("li").append("a").attr("tabindex","-1").text("Center on screen").on("click",function(t){e.fixed=0;_e(e);o.style("display","none")});o.append("li").append("a").attr("tabindex","-1").text(function(t){if(e.fixed)return"Release fix";return"Fix in place"}).on("click",function(t){e.fixed=!e.fixed;o.style("display","none")});e.fixed=1;o.style("position","absolute").style("left",""+d3.event.offsetX+"px").style("top",""+d3.event.offsetY+"px").style("display","block")}else{if(r){r.fixed=0}o.style("display","none")}n.on("click",function(t){A(null,i?null:e)},true)};var E=function(e){var r=d3.select(t);var n="d3_context_menu_id";var a=r.select("#"+n);if(a.empty()){a=r.append("ul").attr("id",n).attr("class","dropdown-menu").attr("role","menu")}a.selectAll("li").remove();if(e){e.fixed=1;a.append("li").append("a").attr("tabindex","-1").text("Collapse cluster").on("click",function(t){e.fixed=0;ve(e,true);a.style("display","none")});a.style("position","absolute").style("left",""+d3.event.offsetX+"px").style("top",""+d3.event.offsetY+"px").style("display","block")}else{a.style("display","none")}r.on("click",function(e){E(null)},true)};function z(e,t,r){var n={id:"root",children:[]};for(var a=0;a<t;a+=1){if(r!=undefined&&r[a+1]!=undefined){continue}n.children.push({cluster_id:a+1,children:e.filter(function(e){return e.cluster==a+1})})}var o=d3.layout.treemap().size([u.width,u.height]).sticky(true).children(function(e){return e.children}).value(function(e){return 1});return o.nodes(n)}function D(){var e={};e.all=[];e.edges=[];e.nodes=[];e.clusters=[];expandedClusters=[];drawnNodes=[];u.clusters.forEach(function(t){var r=t.children.some(function(e){return e.hxb2_linked})&&u.hide_hxb2;if(!r){if(t.collapsed){e.clusters.push(t);e.all.push(t)}else{expandedClusters[t.cluster_id]=true}}});u.nodes.forEach(function(t,r){if(expandedClusters[t.cluster]){drawnNodes[r]=e.nodes.length+e.clusters.length;e.nodes.push(t);e.all.push(t)}});u.edges.forEach(function(t){if(!(t.removed&&u.filter_edges)){if(drawnNodes[t.source]!=undefined&&drawnNodes[t.target]!=undefined){var r={};for(var n in t){r[n]=t[n]}r.source=drawnNodes[t.source];r.target=drawnNodes[t.target];e.edges.push(r)}}});return e}function C(e,t,r){init_layout=z(t,u.cluster_sizes.length,r);e=init_layout.filter(function(e,t,r){return!(typeof e.cluster_id==="undefined")});t=t.map(function(e){e.x+=e.dx/2;e.y+=e.dy/2;return e});e.forEach(le);return[e,t]}function N(e){u.charge_correction=u.charge_correction*e;x.start()}function I(e,t){if(e){u.width+=e;u.height+=e;u.width=Math.min(Math.max(u.width,200),4e3);u.height=Math.min(Math.max(u.height,200),4e3)}x.size([u.width,u.height-160]);w.attr("width",u.width).attr("height",u.height);if(t){x.start()}}u.compute_adjacency_list=_.once(function(){u.nodes.forEach(function(e){e.neighbors=d3.set()});u.edges.forEach(function(e){u.nodes[e.source].neighbors.add(e.target);u.nodes[e.target].neighbors.add(e.source)})});u.compute_local_clustering_coefficients=_.once(function(){u.compute_adjacency_list();u.nodes.forEach(function(e){_.defer(function(e){neighborhood_size=e.neighbors.size();if(neighborhood_size<2){e.lcc=datamonkey.hivtrace.undefined}else{if(neighborhood_size>500){e.lcc=datamonkey.hivtrace.too_large}else{neighborhood=e.neighbors.values();counter=0;for(n1=0;n1<neighborhood_size;n1+=1){for(n2=n1+1;n2<neighborhood_size;n2+=1){if(u.nodes[neighborhood[n1]].neighbors.has(neighborhood[n2])){counter++}}}e.lcc=2*counter/neighborhood_size/(neighborhood_size-1)}}},e)})});u.get_node_by_id=function(e){return u.nodes.filter(function(t){return t.id==e})[0]};u.compute_local_clustering_coefficients_worker=_.once(function(){var e=new Worker("workers/lcc.js");e.onmessage=function(e){var t=e.data.Nodes;t.forEach(function(e){node_to_update=u.get_node_by_id(e.id);node_to_update.lcc=e.lcc?e.lcc:datamonkey.hivtrace.undefined})};var t={};t["Nodes"]=u.nodes;t["Edges"]=u.edges;e.postMessage(t)});estimate_cubic_compute_cost=_.memoize(function(e){u.compute_adjacency_list();return _.reduce(_.first(_.pluck(e.children,"degree").sort(d3.descending),3),function(e,t){return e*t},1)},function(e){return e.cluster_id});u.compute_global_clustering_coefficients=_.once(function(){u.compute_adjacency_list();u.clusters.forEach(function(e){_.defer(function(e){cluster_size=e.children.length;if(cluster_size<3){e.cc=datamonkey.hivtrace.undefined}else{if(estimate_cubic_compute_cost(e,true)>=5e6){e.cc=datamonkey.hivtrace.too_large}else{member_nodes=[];var t=0;var r=0;u.nodes.forEach(function(t,r){if(t.cluster==e.cluster_id){member_nodes.push(r)}});member_nodes.forEach(function(e){my_neighbors=u.nodes[e].neighbors.values().map(function(e){return+e}).sort(d3.ascending);for(n1=0;n1<my_neighbors.length;n1+=1){for(n2=n1+1;n2<my_neighbors.length;n2+=1){t+=1;if(u.nodes[my_neighbors[n1]].neighbors.has(my_neighbors[n2])){r+=1}}}});e.cc=r/t}}},e)})});u.mark_nodes_as_processing=function(e){u.nodes.forEach(function(t){t[e]=datamonkey.hivtrace.processing})};u.compute_graph_stats=function(){d3.select(this).classed("disabled",true).select("i").classed({"fa-calculator":false,"fa-cog":true,"fa-spin":true});u.mark_nodes_as_processing("lcc");u.compute_local_clustering_coefficients_worker();u.compute_global_clustering_coefficients();d3.select(this).remove()};function M(){var e=[];var t=0;var r={};u.has_hxb2_links=false;u.cluster_sizes=[];h.Nodes.forEach(function(e){if(typeof u.cluster_sizes[e.cluster-1]==="undefined"){u.cluster_sizes[e.cluster-1]=1}else{u.cluster_sizes[e.cluster-1]++}if("is_lanl"in e){e.is_lanl=e.is_lanl=="true"}if(e.attributes.indexOf("problematic")>=0){u.has_hxb2_links=e.hxb2_linked=true}});if(a){var n=d3.select("#"+a+"_cluster_operations_container");[["Expand All",function(){return u.expand_some_clusters()},true],["Collapse All",function(){return u.collapse_some_clusters()},true],["Expand Filtered",function(){return u.expand_some_clusters(u.select_some_clusters(function(e){return e.match_filter}))},true],["Collapse Filtered",function(){return u.collapse_some_clusters(u.select_some_clusters(function(e){return e.match_filter}))},true],["Hide problematic clusters",function(e){d3.select(e).text(u.hide_hxb2?"Hide problematic clusters":"Show problematic clusters");u.toggle_hxb2()},u.has_hxb2_links],["Show removed edges",function(e){u.filter_edges=!u.filter_edges;d3.select(e).text(u.filter_edges?"Show removed edges":"Hide removed edges");u.update(false)},function(){return _.some(u.edges,function(e){return e.removed})}]].forEach(function(e,t){var r=e[1];if(e[2]){this.append("li").append("a").text(e[0]).attr("href","#").on("click",function(e){r(this);d3.event.preventDefault()})}},n);var i=d3.select("#"+a+"_button_group");if(!i.empty()){i.append("button").classed("btn btn-default btn-sm",true).attr("title","Expand spacing").on("click",function(e){N(5/4)}).append("i").classed("fa fa-arrows",true);i.append("button").classed("btn btn-default btn-sm",true).attr("title","Compress spacing").on("click",function(e){N(4/5)}).append("i").classed("fa fa-arrows-alt",true);i.append("button").classed("btn btn-default btn-sm",true).attr("title","Enlarge window").on("click",function(e){I(20,true)}).append("i").classed("fa fa-expand",true);i.append("button").classed("btn btn-default btn-sm",true).attr("title","Shrink window").on("click",function(e){I(-20,true)}).append("i").classed("fa fa-compress",true);i.append("button").classed("btn btn-default btn-sm",true).attr("title","Compute graph statistics").on("click",function(e){_.bind(u.compute_graph_stats,this)()}).append("i").classed("fa fa-calculator",true);i.append("button").classed("btn btn-default btn-sm",true).attr("title","Save Image").attr("id","hivtrace-export-image").on("click",function(e){datamonkey.save_image("png","#network-svg")}).append("i").classed("fa fa-image",true)}$("#"+a+"_filter").on("input propertychange",_.throttle(function(e){var t=$(this).val();u.filter(t.split(" ").filter(function(e){return e.length>0}).map(function(e){return new RegExp(e,"i")}))},250))}if(o&&"hivtrace"in o){o=o["hivtrace"]}if(o&&"attribute_map"in o){var l=o["attribute_map"];if("map"in l&&l["map"].length>0){h[_networkGraphAttrbuteID]=l["map"].map(function(e,t){return{label:e,type:null,values:{},index:t,range:0}});h.Nodes.forEach(function(e){e[_networkGraphAttrbuteID]=e.id.split(l["delimiter"]);e[_networkGraphAttrbuteID].forEach(function(e,t){if(t<h[_networkGraphAttrbuteID].length){if(!(e in h[_networkGraphAttrbuteID][t]["values"])){h[_networkGraphAttrbuteID][t]["values"][e]=h[_networkGraphAttrbuteID][t]["range"];h[_networkGraphAttrbuteID][t]["range"]+=1}}})});h[_networkGraphAttrbuteID].forEach(function(e){if(e["range"]<h.Nodes.length&&e["range"]>1&&e["range"]<=20){e["type"]="category"}});if(a){var s=h[_networkGraphAttrbuteID].filter(function(e){return e["type"]=="category"});[d3.select("#"+a+"_attributes"),d3.select("#"+a+"_attributes_cat")].forEach(function(e){e.selectAll("li").remove();var t=e.selectAll("li").data([[["None",-1]],[["Categorical",-2]]].concat(s.map(function(e){return[[e["label"],e["index"]]]})));t.enter().append("li").classed("disabled",function(e){return e[0][1]<-1});t.selectAll("a").data(function(e){return e}).enter().append("a").text(function(e,t,r){return e[0]}).attr("style",function(e,t,r){if(e[1]<-1)return"font-style: italic";if(r==0){return" font-weight: bold;"}return null}).attr("href","#").on("click",function(e){V(e[1])})})}}}if(u.cluster_sizes.length>m){var c=u.cluster_sizes.map(function(e,t){return[e,t+1]}).sort(function(e,t){return e[0]-t[0]});for(var d=0;d<c.length-m;d++){r[c[d][1]]=1}g="Excluded "+(c.length-m)+" clusters (maximum size "+c[d-1][0]+" nodes) because only "+m+" points can be shown at once."}v=h.Nodes.filter(function(e,t){return e.cluster===null}).length;u.nodes=h.Nodes.filter(function(n,a){if(n.cluster&&typeof r[n.cluster]==="undefined"){e[a]=t++;return true}return false});u.edges=h.Edges.filter(function(t,r){return e[t.source]!=undefined&&e[t.target]!=undefined});u.edges=u.edges.map(function(t,r){t.source=e[t.source];t.target=e[t.target];t.id=r;return t});K(u.nodes,u.edges);var p=C(u.clusters,u.nodes,r);u.clusters=p[0];u.nodes=p[1];u.clusters.forEach(function(e,t){f[e.cluster_id]=t;e.hxb2_linked=e.children.some(function(e){return e.hxb2_linked});var r=e.children.map(function(e){return e.degree});r.sort(d3.ascending);e.degrees=datamonkey_describe_vector(r)});u.update()}function F(e,t){if(t){$(e).data("sorted",t);d3.select(e).selectAll("i").classed("fa-sort-amount-desc",t=="desc").classed("fa-sort-amount-asc",t=="asc").classed("fa-sort",t=="unsorted")}else{var r=$(e).data("sorted");F(e,r=="asc"?"desc":"asc");return r=="asc"?d3.descending:d3.ascending}}function S(e,t){d3.event.preventDefault();var r=$(e).closest("table");if(r.length){var n=parseInt($(e).data("column-id"));var a=$(e).data("sort-on");var o=$(e).data("sorted");var i=F(e);sort_accessor=a?function(e){var t=e[a];if(typeof t==="function")return t();return t}:function(e){return e};d3.select(r[0]).select("tbody").selectAll("tr").sort(function(e,t){return i(sort_accessor(e[n]),sort_accessor(t[n]))});$(r).find("thead [data-column-id]").filter(function(){return parseInt($(this).data("column-id"))!=n}).each(function(){F(this,"unsorted")})}}function R(e,t,r){var n=d3.select(r);current_value=typeof e.value==="function"?e.value():e.value;if("callback"in e){e.callback(r,current_value)}else{var a="format"in e?e.format(current_value):current_value;if("html"in e)n.html(a);else n.text(a);if("sort"in e){var o=n.append("a").property("href","#").on("click",function(e){S(this,e)}).attr("data-sorted","unsorted").attr("data-column-id",t).attr("data-sort-on",e.sort);o.append("i").classed("fa fa-sort",true).style("margin-left","0.2em")}}if("help"in e){n.attr("title",e.help)}}function G(e,t,r){var n=e.selectAll("thead");if(n.empty()){n=e.append("thead");n.selectAll("tr").data(t).enter().append("tr").selectAll("th").data(function(e){return e}).enter().append("th").call(function(e){return e.each(function(e,t){R(e,t,this)})})}var a=e.selectAll("tbody");if(a.empty()){a=e.append("tbody");a.selectAll("tr").data(r).enter().append("tr").selectAll("td").data(function(e){return e}).enter().append("td").call(function(e){return e.each(function(e,t){A;R(e,t,this)})})}}function O(e,t){var r=d3.select(e);var n=[[t[0]?"collapsed":"expanded",0]];if(t[1]){n.push(["problematic",1])}var a=r.selectAll("button").data(n);a.enter().append("button");a.exit().remove();a.classed("btn btn-primary btn-xs",true).text(function(e){return e[0]}).attr("disabled",function(e){return e[1]?"disabled":null}).on("click",function(r){if(r[1]==0){if(t[0]){se(u.clusters[t[t.length-1]-1],true)}else{le(u.clusters[t[t.length-1]-1])}R(d3.select(e).datum(),null,e)}})}function T(e,t){var r=d3.select(e);var n=[[t[0]?"shown":"hidden",0]];var a=r.selectAll("button").data(n);a.enter().append("button");a.exit().remove();a.classed("btn btn-primary btn-xs",true).text(function(e){return e[0]}).attr("disabled",function(e){return e[1]?"disabled":null}).on("click",function(r){if(r[1]==0){if(t[0]){le(u.clusters[t[t.length-1]-1],true)}else{se(u.clusters[t[t.length-1]-1])}R(d3.select(e).datum(),null,e)}})}u.update_volatile_elements=function(e){e.selectAll("td").filter(function(e,t){return"volatile"in e}).each(function(e,t){R(e,t,this)})};function H(){if(u.node_table){G(u.node_table,[[{value:"ID",sort:"value",help:"Node ID"},{value:"Properties",sort:"value"},{value:"Degree",sort:"value",help:"Node degree"},{value:"Cluster",sort:"value",help:"Which cluster does the node belong to"},{value:"LCC",sort:"value",help:"Local clustering coefficient"}]],u.nodes.map(function(e,t){console.log(datamonkey.hivtrace.format_value(e.lcc,_defaultFloatFormat));return[{value:e.id,help:"Node ID"},{value:function(){return[!u.clusters[e.cluster-1].collapsed,e.cluster]},callback:T,"volatile":true},{value:e.degree,help:"Node degree"},{value:e.cluster,help:"Which cluster does the node belong to"},{value:function(){return datamonkey.hivtrace.format_value(e.lcc,_defaultFloatFormat)},"volatile":true,html:true,help:"Local clustering coefficient"}]}))}}function L(){if(u.cluster_table){G(u.cluster_table,[[{value:"ID",sort:"value",help:"Unique cluster ID"},{value:"Properties",sort:"value"},{value:"Size",sort:"value",help:"Number of nodes in the cluster"},{value:"Degrees<br>Mean [Median, IQR]",html:true},{value:"CC",sort:"value",help:"Global clustering coefficient"},{value:"MPL",sort:"value",help:"Mean Path Length"}]],u.clusters.map(function(e,t){return[{value:e.cluster_id},{value:function(){return[e.collapsed,e.hxb2_linked,e.cluster_id]},callback:O,"volatile":true},{value:e.children.length},{value:e.degrees,format:function(e){return _defaultFloatFormat(e["mean"])+" ["+_defaultFloatFormat(e["median"])+", "+_defaultFloatFormat(e["Q1"])+" - "+_defaultFloatFormat(e["Q3"])+"]"}},{value:function(){return hivtrace_format_value(e.cc,_defaultFloatFormat)},"volatile":true,help:"Global clustering coefficient"},{value:function(){return hivtrace_format_value(e.mpl,_defaultFloatFormat)},"volatile":true,help:"Mean path length"}]}))}}function U(e){if(r){var t=u.clusters.length-e.clusters.length,n=u.cluster_sizes.length-u.clusters.length,a=h.Nodes.length-v-u.nodes.length;var o="Displaying a network on <strong>"+u.nodes.length+"</strong> nodes, <strong>"+u.clusters.length+"</strong> clusters"+(n>0?" (an additional "+n+" clusters and "+a+" nodes have been removed due to network size constraints)":"")+". <strong>"+t+"</strong> clusters are expanded. Of <strong>"+u.edges.length+"</strong> edges, <strong>"+e.edges.length+"</strong>, and of  <strong>"+u.nodes.length+" </strong> nodes,  <strong>"+e.nodes.length+" </strong> are displayed. ";if(v>0){o+="<strong>"+v+"</strong> singleton nodes are not shown. "}d3.select(r).html(o)}}function P(e,t){e=d3.select(e);e.attr("d",d3.svg.symbol().size(Y).type(function(e){return e.hxb2_linked&&!e.is_lanl?"cross":e.is_lanl?"triangle-down":"circle"})).attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}).style("fill",function(e){return X(e)}).on("click",E).on("mouseover",re).on("mouseout",ne).call(x.drag().on("dragstart",ne))}function B(e,t){container_group=d3.select(e);var r=t["binned_attributes"]?t["binned_attributes"].map(function(e){return e.concat([0])}):[[null,1,0]];if(t.match_filter){r=r.concat([["selected",t.match_filter,1],["not selected",t.children.length-t.match_filter,1]])}var n=[d3.sum(r.filter(function(e){return e[2]==0}),function(e){return e[1]}),d3.sum(r.filter(function(e){return e[2]!=0}),function(e){return e[1]})];var a=[0,0];r=r.map(function(r){index=r[2];var o={container:e,cluster:t,startAngle:a[index]/n[index]*2*Math.PI,endAngle:(a[index]+r[1])/n[index]*2*Math.PI,name:r[0],rim:index>0};a[index]+=r[1];return o});var o=ye(t)*.5;var i=container_group.selectAll("path").data(r);i.enter().append("path");i.exit().remove();i.classed("cluster",true).classed("hiv-trace-problematic",function(e){return t.hxb2_linked&&!e.rim}).classed("hiv-trace-selected",function(e){return e.rim}).attr("d",function(e){return(e.rim?d3.svg.arc().innerRadius(o+2).outerRadius(o+5):d3.svg.arc().innerRadius(0).outerRadius(o))(e)}).style("fill",function(e,r){return e.rim?u.colorizer["selected"](e.name):Z(t,e.name)})}function V(e){var t="None";["#"+a+"_attributes","#"+a+"_attributes_cat"].forEach(function(r){d3.select(r).selectAll("li").selectAll("a").attr("style",function(r,n){if(r[1]==e){t=r[0];return" font-weight: bold;"}return null});d3.select(r+"_label").html(t+' <span class="caret"></span>')});u.clusters.forEach(function(t){t["binned_attributes"]=be(fe(t,e))});if(e>=0){u.colorizer["category"]=h[_networkGraphAttrbuteID][e]["range"]<=10?d3.scale.category10():d3.scale.category20c();u.colorizer["category_id"]=e;u.colorizer["category_map"]=h[_networkGraphAttrbuteID][e]["values"];u.colorizer["category_map"][null]=h[_networkGraphAttrbuteID][e]["range"];u.colorizer["category_pairwise"]=ue(e,h[_networkGraphAttrbuteID][e]["range"]+1,u.colorizer["category_map"]);de("#"+a+"_aux_svg_holder",u.colorizer["category_map"],u.colorizer["category_pairwise"]);ce("#"+a+"_attribute_table",u.colorizer["category_map"],u.colorizer["category_pairwise"])}else{u.colorizer["category"]=null;u.colorizer["category_id"]=null;u.colorizer["category_pairwise"]=null;u.colorizer["category_map"]=null;de("#"+a+"_aux_svg_holder",null,null);ce("#"+a+"_attribite_table",null,null)}console.log(u.colorizer,h[_networkGraphAttrbuteID]);u.update(true);d3.event.preventDefault()}u.filter=function(e,t){var r=false;u.clusters.forEach(function(e){e.match_filter=0});u.nodes.forEach(function(t){var n=_.some(e,function(e){return e.test(t.id)});if(n!=t.match_filter){t.match_filter=n;r=true}if(t.match_filter){t.parent.match_filter+=1}});if(r&&!t){u.update(true)}};u.update=function(e,t){u.needs_an_update=false;if(t){x.friction(t)}if(n){if(g.length){d3.select(n).text(g).style("display","block");g=""}else{d3.select(n).style("display","none")}}var r,a,o;if(!e){var i=D();x.nodes(i.all).links(i.edges).start();U(i);o=w.selectAll(".link").data(i.edges,function(e){return e.id});var l=o.enter().append("line").classed("link",true).classed("removed",function(e){return e.removed}).classed("unsupported",function(e){return"support"in e&&e["support"]>.05}).on("mouseover",ae).on("mouseout",oe).filter(function(e){return e.directed}).attr("marker-end","url(#arrowhead)");o.exit().remove();r=w.selectAll(".node").data(i.nodes,function(e){return e.id});r.exit().remove();r.enter().append("path");a=w.selectAll(".cluster-group").data(i.clusters.map(function(e){return e}),function(e){return e.cluster_id});a.exit().remove();a.enter().append("g").attr("class","cluster-group").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}).on("click",A).on("mouseover",he).on("mouseout",me).call(x.drag().on("dragstart",me));L();H()}else{r=w.selectAll(".node");a=w.selectAll(".cluster-group");o=w.selectAll(".link")}r.each(function(e){P(this,e)});a.each(function(e){B(this,e)});if(!e){b=a[0].length+r[0].length;x.on("tick",function(){o.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y});r.attr("transform",function(e){return"translate("+e.x+","+e.y+")"});a.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})})}};function q(){link.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y});node.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}function K(e,t){
for(var r in e){e[r].degree=0}for(var n in t){e[t[n].source].degree++;e[t[n].target].degree++}}function Q(e,t){if(_networkGraphAttrbuteID in e){if(t){return e[_networkGraphAttrbuteID][t]}}return null}function W(e){if(typeof e=="number"){return h[_networkGraphAttrbuteID][e]["label"]}return null}function Y(e){var t=3+Math.sqrt(e.degree);return(e.match_filter?10:4)*t*t}function X(e){if(e.match_filter){return"white"}var t=Q(e,u.colorizer["category_id"]);if(t){return u.colorizer["category"](t)}return e.hxb2_linked?"black":e.is_lanl?"red":"#7fc97f"}function Z(e,t){if(e["binned_attributes"]){return u.colorizer["category"](t)}return"#bdbdbd"}function J(e){return"black"}function ee(e){var t="Degree <em>"+e.degree+"</em>"+"<br>Clustering coefficient <em> "+datamonkey.hivtrace.format_value(e.lcc,_defaultFloatFormat)+"</em>";var r=Q(e,u.colorizer["category_id"]);if(r){t+="<br>"+W(u.colorizer["category_id"])+" <em>"+r+"</em>"}return t}function te(e){var t="Length <em>"+_defaultFloatFormat(e.length)+"</em>";if("support"in e){t+="<br>Worst triangle-based support (p): <em>"+_defaultFloatFormat(e.support)+"</em>"}var r=Q(e,u.colorizer["category_id"]);return t}function re(e){xe(this,true,"Node "+e.id,ee(e))}function ne(e){xe(this,false)}function ae(e){xe(this,true,e.source.id+" - "+e.target.id,te(e))}function oe(e){xe(this,false)}function ie(e){for(var t in e){var r=e[t];r.x=0;r.y=0;r.children.forEach(function(e){r.x+=e.x;r.y+=e.y});r.x/=r.children.length;r.y/=r.children.length}}function le(e,t){u.needs_an_update=true;e.collapsed=true;b-=u.cluster_sizes[e.cluster_id-1]-1;if(!t){var r=y.indexOf(e.cluster_id);if(r>=0){y.splice(r,1)}}ie([e]);return e.children.length}function se(e,t){u.needs_an_update=true;e.collapsed=false;b+=u.cluster_sizes[e.cluster_id-1]-1;y.push(e.cluster_id);if(t){e.children.forEach(function(t){t.x=e.x+(Math.random()-.5)*e.children.length;t.y=e.y+(Math.random()-.5)*e.children.length})}else{e.children.forEach(function(t){t.x=u.width*.25+(Math.random()-.5)*e.children.length;t.y=.25*u.height+(Math.random()-.5)*e.children.length})}}function ce(e,t,r){var n=d3.select(e);n.selectAll("thead").remove();n.selectAll("tbody").remove();if(r){var a=u.colorizer["category"];lookup=_.invert(t);var o=n.append("thead").append("tr").selectAll("th").data([""].concat(r[0].map(function(e,t){return lookup[t]})));o.enter().append("th");o.html(function(e){return"<span>&nbsp;"+e+"</span>"}).each(function(e,t){if(t){d3.select(this).insert("i",":first-child").classed("fa fa-circle",true).style("color",function(){return a(e)})}});var i=n.append("tbody").selectAll("tr").data(r.map(function(e,t){return[lookup[t]].concat(e)}));i.enter().append("tr");i.selectAll("td").data(function(e){return e}).enter().append("td").html(function(e,t){return t==0?"<span>&nbsp;"+e+"</span>":e}).each(function(e,t){if(t==0){d3.select(this).insert("i",":first-child").classed("fa fa-circle",true).style("color",function(){return a(e)})}})}}function de(e,t,r){d3.select(e).selectAll("svg").remove();if(r){lookup=_.invert(t);var n=d3.select(e).append("svg");var a=d3.layout.chord().padding(.05).sortSubgroups(d3.descending).matrix(r);var o=20,i=450,l=450,s=Math.min(i,l-o)*.41,c=s*1.1;var d=u.colorizer["category"],f=12;var p=n.append("g").attr("transform","translate("+i/2+","+(l-o)+")").append("text").attr("text-anchor","middle").attr("font-size",f).text("");n=n.attr("width",i).attr("height",l-o).append("g").attr("transform","translate("+i/2+","+(l-o)/2+")");n.append("g").selectAll("path").data(a.groups).enter().append("path").style("fill",function(e){return d(lookup[e.index])}).style("stroke",function(e){return d(lookup[e.index])}).attr("d",d3.svg.arc().innerRadius(s).outerRadius(c)).on("mouseover",h(.1,true)).on("mouseout",h(1,false));n.append("g").attr("class","chord").selectAll("path").data(a.chords).enter().append("path").attr("d",d3.svg.chord().radius(s)).style("fill",function(e){return d(e.target.index)}).style("opacity",1);function h(e,t){return function(r,a){p.text(t?lookup[a]:"");n.selectAll(".chord path").filter(function(e){return e.source.index!=a&&e.target.index!=a}).transition().style("opacity",e)}}}}function ue(e,t,r,n){var a=n?draw_me.edges:u.edges;var o=[];for(i=0;i<t;i+=1){o.push([]);for(j=0;j<t;j+=1){o[i].push(0)}}a.forEach(function(t){o[r[Q(u.nodes[t.source],e)]][r[Q(u.nodes[t.target],e)]]+=1});var l=o.some(function(e,r){if(r==t-1){return e.some(function(e){return e>0})}return e[t-1]>0});if(!l){o.pop();for(i=0;i<t-1;i+=1){o[i].pop()}}return o}function fe(e,t){if(t>=0&&e){return e.children.map(function(e){return _networkGraphAttrbuteID in e?e[_networkGraphAttrbuteID][t]:null})}return null}function pe(e){var t=u.clusters[e-1],r=t["binned_attributes"];var n="<strong>"+u.cluster_sizes[e-1]+"</strong> nodes."+"<br>Mean degree <em>"+_defaultFloatFormat(t.degrees["mean"])+"</em>"+"<br>Max degree <em>"+t.degrees["max"]+"</em>"+"<br>Clustering coefficient <em> "+datamonkey.hivtrace.format_value(t.cc,_defaultFloatFormat)+"</em>";if(r){r.forEach(function(e){n+="<br>"+e[0]+" <em>"+e[1]+"</em>"})}return n}function he(e){xe(this,true,"Cluster "+e.cluster_id,pe(e.cluster_id))}function me(e){xe(this,false)}function ge(e,t,r){if(e.collapsed){var n=u.cluster_sizes[e.cluster_id-1]-1;if(n>m){g="This cluster is too large to be displayed"}else{var a=n+b-m;if(a>0){for(k=0;k<y.length&&a>0;k++){var o=u.clusters[f[y[k]]];a-=o.children.length-1;le(o,true)}if(k||y.length){y.splice(0,k)}}if(a<=0){se(e,!r)}}if(t){u.update(false,.6)}}return""}function ve(e,t){le(u.clusters[f[e.cluster]]);if(t){u.update(false,.4)}}function _e(e){e.x=u.width/2;e.y=u.height/2;u.update(false,.4)}function ye(e){return 5*Math.sqrt(e.children.length)}u.expand_some_clusters=function(e){e=e||u.clusters;e.forEach(function(e){ge(e,false)});u.update()};u.select_some_clusters=function(e){return u.clusters.filter(function(t,r){return _.some(t.children,function(t){return e(t)})})};u.collapse_some_clusters=function(e){e=e||u.clusters;e.forEach(function(e){if(!e.collapsed)le(e)});u.update()};u.toggle_hxb2=function(){u.hide_hxb2=!u.hide_hxb2;u.update()};$("#reset_layout").click(function(e){C(clusters,nodes);u.update();e.preventDefault()});function be(e){if(e){var t={},r=[];e.forEach(function(e){if(e in t){t[e]+=1}else{t[e]=1}});for(var n in t){r.push([n,t[n]])}return r.sort(function(e,t){return e[0]-t[0]})}return e}function xe(e,t,r,n){if(t&&!e.tooltip){$("[role='tooltip']").each(function(e){$(this).remove()});var a=$(e);var o=d3.select(e).datum();e.tooltip=a.tooltip({title:r+"<br>"+n,html:true,container:"body"});_.delay(_.bind(e.tooltip.tooltip,e.tooltip),500,"show")}else{if(t==false&&e.tooltip){e.tooltip.tooltip("destroy");e.tooltip=undefined}}}M();return u};var hivtrace_cluster_graph_summary=function(e,t){var r=d3.select(t).append("tbody");var n=[];if(!r.empty()){_.each(e["Network Summary"],function(e,t){n.push([t,e])})}var a=[];_.each(e["Degrees"]["Distribution"],function(e,t){for(k=0;k<e;k++){a.push(t+1)}});a=datamonkey.helpers.describe_vector(a);n.push(["Degrees",""]);n.push(["&nbsp;&nbsp;<i>Mean</i>",_defaultFloatFormat(a["mean"])]);n.push(["&nbsp;&nbsp;<i>Median</i>",_defaultFloatFormat(a["median"])]);n.push(["&nbsp;&nbsp;<i>Range</i>",a["min"]+" - "+a["max"]]);n.push(["&nbsp;&nbsp;<i>IQR</i>",a["Q1"]+" - "+a["Q3"]]);a=datamonkey.helpers.describe_vector(e["Cluster sizes"]);n.push(["Cluster sizes",""]);n.push(["&nbsp;&nbsp;<i>Mean</i>",_defaultFloatFormat(a["mean"])]);n.push(["&nbsp;&nbsp;<i>Median</i>",_defaultFloatFormat(a["median"])]);n.push(["&nbsp;&nbsp;<i>Range</i>",a["min"]+" - "+a["max"]]);n.push(["&nbsp;&nbsp;<i>IQR</i>",a["Q1"]+" - "+a["Q3"]]);r.selectAll("tr").data(n).enter().append("tr").selectAll("td").data(function(e){return e}).enter().append("td").html(function(e){return e})};datamonkey.hivtrace.cluster_network_graph=hivtrace_cluster_network_graph;datamonkey.hivtrace.graph_summary=hivtrace_cluster_graph_summary;function hivtrace_histogram(e,t,r){var n=d3.format(",.2f");var a=300,o=300;hivtrace_render_histogram(e["Degrees"]["Distribution"],e["Degrees"]["fitted"],a,o,t);var i="Network degree distribution is best described by the <strong>"+e["Degrees"]["Model"]+"</strong> model, with &rho; of "+n(e["Degrees"]["rho"]);if(e["Degrees"]["rho CI"]!=undefined){i+=" (95% CI "+n(e["Degrees"]["rho CI"][0])+" - "+n(e["Degrees"]["rho CI"][1])+")"}d3.select(r).html(i)}function hivtrace_render_histogram(e,t,r,n,a){var o={top:10,right:30,bottom:50,left:30},i=r-o.left-o.right,l=n-o.top-o.bottom;var s=d3.scale.linear().domain([0,e.length+1]).range([0,i]);var c=d3.scale.log().domain([1,d3.max(e)]).range([l,0]);var d=d3.sum(e);var u=d3.svg.axis().scale(s).orient("bottom");var f=d3.select(a).selectAll("svg");if(f!=undefined){f.remove()}var p=e.map(function(e,t){return{x:t+1,y:e+1}});p.push({x:e.length+1,y:1});p.push({x:0,y:1});p.push({x:0,y:e[0]+1});f=d3.select(a).insert("svg",".histogram-label").attr("width",i+o.left+o.right).attr("height",l+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")").datum(p);var h=d3.svg.line().x(function(e){return s(e.x)}).y(function(e){return c(e.y)}).interpolate("step-before");f.selectAll("path").remove();f.append("path").attr("d",function(e){return h(e)+"Z"}).attr("class","histogram");if(t!=undefined){var m=d3.svg.line().interpolate("linear").x(function(e,t){return s(t+1)+(s(t+1)-s(t))/2}).y(function(e){return c(1+e*d)});f.append("path").datum(t).attr("class","line").attr("d",function(e){return m(e)})}var g=f.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(u);g.selectAll("text").attr("transform","rotate(45)").attr("dx","1em").attr("dy","0.5em")}datamonkey.hivtrace.histogram=hivtrace_histogram;function hivtrace_cluster_adjacency_list(e){var t=e.Nodes,r=e.Edges;var n={};r.forEach(function(e,r){function a(e,t){return e.id==t}var o=e["sequences"];var i=t.filter(function(e){return a(e,o[0])})[0],l=t.filter(function(e){return a(e,o[1])})[0];n[i.id]?n[i.id].push(l):n[i.id]=[l];n[l.id]?n[l.id].push(i):n[l.id]=[i]});return n}function hivtrace_new_cluster_adjacency_list(e){var t=e.Nodes,r=e.Edges;t.forEach(function(e){e.neighbors=d3.set()});r.forEach(function(e){t[e.source].neighbors.add(e.target);t[e.target].neighbors.add(e.source)})}function hivtrace_get_path(e,t,r){var n=[];var t=parseInt(t);var r=parseInt(r);for(var a=0;a<e[t][r].length;a++){var o=e[t][r][a];var i=o;if(i==null||i==t){return[[parseInt(t),parseInt(r)]]}else{var l=hivtrace_get_path(e,t,i);var s=hivtrace_get_path(e,i,r);for(var c=0;c<l.length;c++){var d=l[c];for(var u=0;u<s.length;u++){var f=s[u];if(d.length){if(d[0]==t&&d[d.length-1]==o&&f[0]==o&&f[f.length-1]==r){d.pop();n.push(d.concat(f))}}}}}}return n}function hivtrace_paths_with_node(e,t,r,n){var a=hivtrace_get_path(t,r,n);a=a.map(function(e){return e.slice(1,-1)});if(!a){return 0}var o=[];for(var r=0;r<a.length;r++){sublist=a[r];o.push(d3.sum(sublist.map(function(t){return t==e})))}var i=d3.mean(o);if(i==undefined){i=0}return i}function hivtrace_compute_shortest_paths_with_reconstruction(e,t,r){var n=[];var a=[];var o=e.Nodes;var i=e.Edges;var l=[];var s=datamonkey.hivtrace.cluster_adjacency_list(e);if(!t){t=Object.keys(s)}var c=t.length;for(var d=0;d<t.length;d++){var u=t[d];var f=_.range(c).map(function(e){return null});var p=_.range(c).map(function(e){return null});n.push(p);a.push(f)}for(var h=0;h<t.length;h++){var u=t[h];for(var m=0;m<t.length;m++){var g=t[m];if(g!=u){if(s[u].map(function(e){return e.id}).indexOf(g)!=-1){n[h][m]=1;n[m][h]=1}}}}for(var v=0;v<t.length;v++){var y=t[v];for(var b=0;b<t.length;b++){var x=t[b];if(v==b){a[v][b]=[]}else{a[v][b]=[v]}}}var k=_.map(n,_.clone);var w=0;for(var A=0;A<t.length;A++){var $=t[A];for(var v=0;v<t.length;v++){var y=t[v];for(var b=0;b<t.length;b++){var x=t[b];if(y!=x){d_ik=n[A][v];d_jk=n[A][b];d_ij=n[v][b];if(d_ik!=null&&d_jk!=null){d_ik+=d_jk;if(d_ij==null||d_ij>d_ik){k[v][b]=d_ik;k[b][v]=d_ik;a[v][b]=[];a[v][b]=a[v][b].concat(a[A][b]);continue}else if(d_ij==d_ik){a[v][b]=a[v][b].concat(a[A][b])}}w++;k[b][v]=n[b][v];k[v][b]=n[v][b]}}}var E=k;k=n;n=E}return{ordering:t,distances:n,next:a}}function hivtrace_filter_to_node_in_cluster(e,t){var r=t.Nodes,n=t.Edges,a=null;var o=r.filter(function(t){return e==t.id});if(o){a=o[0].cluster}else{console.log("could not find node");return null}var i=r.filter(function(e){return a==e.cluster});var l=i.map(function(e){return e.id});var s=n.filter(function(e){return l.indexOf(e.sequences[0])!=-1});var c={};c["Nodes"]=i;c["Edges"]=s;return c}function hivtrace_compute_betweenness_centrality_all_nodes_in_cluster(e,t,r){var n=t.Nodes,a=t.Edges;var o=n.filter(function(t){return e==t.cluster});var i=o.map(function(e){return e.id});var l=a.filter(function(e){return i.indexOf(e.sequences[0])!=-1});var s={};s["Nodes"]=o;s["Edges"]=l;if(o.length>70){r("cluster too large",null);return}var c=hivtrace_compute_shortest_paths_with_reconstruction(s);var i=o.map(function(e){return e.id});var d={};o.forEach(function(e){d[e.id]=hivtrace_compute_betweenness_centrality(e.id,s,c)});r(null,d);return}function hivtrace_compute_betweenness_centrality(e,t,r){if(!r){var n=hivtrace_filter_to_node_in_cluster(e,t);r=hivtrace_compute_shortest_paths_with_reconstruction(n)}var a=r["ordering"].indexOf(e);if(a==-1){return null}var o=r["distances"].length;if(o!=2){scale=1/((o-1)*(o-2))}else{scale=1}var l=[];for(i in _.range(o)){for(j in _.range(o)){l.push(hivtrace_paths_with_node(a,r["next"],i,j))}}return d3.sum(l)*scale}function hivtrace_compute_node_degrees(e){var t=e.Nodes,r=e.Edges;for(var n in t){t[n].degree=0}for(var a in r){t[r[a].source].degree++;t[r[a].target].degree++}}function hivtrace_get_node_by_id(e,t){return t.Nodes.filter(function(t){return e==t.id})[0]||undefined}function hivtrace_compute_cluster_betweenness(e,t){var r=e.Nodes;function n(e,t,r){return r.indexOf(e)===t}var a=r.map(function(e){return e.cluster});var o=a.filter(n);var i=0;function l(r,n){i++;for(node in n){hivtrace_get_node_by_id(node,e)["betweenness"]=n[node]}if(i>=o.length){t("done")}}o.forEach(function(t){datamonkey.hivtrace.betweenness_centrality_all_nodes_in_cluster(t,e,l)})}function hivtrace_is_contaminant(e){return e.attributes.indexOf("problematic")!=-1}function hivtrace_convert_to_csv(e,t){hivtrace_compute_node_degrees(e);hivtrace_compute_cluster_betweenness(e,function(r){var n=e.Nodes.map(function(e){return[e.id,e.cluster,e.degree,e.betweenness,hivtrace_is_contaminant(e),e.attributes.join(";")]});n.unshift(["seqid","cluster","degree","betweenness","is_contaminant","attributes"]);node_csv=d3.csv.format(n);t(null,node_csv)})}function hivtrace_export_csv_button(e,t){var r=hivtrace_convert_to_csv(e,function(e,r){if(r!=null){var n=document.createElement("a");n.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(r));n.setAttribute("download","export.csv");n.className="btn btn-default btn-sm";n.innerHTML='<span class="glyphicon glyphicon-floppy-save"></span> Export Results';$(t).append(n)}})}function hiv_trace_export_table_to_text(e,t,r){var n=d3.select(e).append("a").attr("target","_blank").on("click",function(e,t){var r=d3.select(this).attr("data-table");var n=datamonkey.helpers.table_to_text(r);datamonkey.helpers.export_handler(n,r.substring(1)+".tsv","text/tab-separated-values")}).attr("data-table",t);n.append("i").classed("fa fa-download fa-2x",true);return n}hivtrace_compute_local_clustering_coefficients=_.once(function(e){datamonkey.hivtrace.new_cluster_adjacency_list(e);var t=e.Nodes;t.forEach(function(e){var r=e;var n=r.neighbors.size();if(n<2){r.lcc=undefined}else{if(n>500){r.lcc=datamonkey.hivtrace.too_large}else{neighborhood=r.neighbors.values();counter=0;for(n1=0;n1<n;n1+=1){for(n2=n1+1;n2<n;n2+=1){if(t[neighborhood[n1]].neighbors.has(neighborhood[n2])){counter++}}}r.lcc=2*counter/n/(n-1)}}})});function hivtrace_render_settings(e,t){}function hivtrace_format_value(e,t){if(typeof e==="undefined"){return"Not computed"}if(e===datamonkey.hivtrace.undefined){return"Undefined"}if(e===datamonkey.hivtrace.too_large){return"Size limit"}if(e===datamonkey.hivtrace.processing){return'<span class="fa fa-spin fa-spinner"></span>'}return t?t(e):e}if(typeof datamonkey=="undefined"){datamonkey=function(){}}if(typeof datamonkey.hivtrace=="undefined"){datamonkey.hivtrace=function(){}}datamonkey.hivtrace.compute_node_degrees=hivtrace_compute_node_degrees;datamonkey.hivtrace.export_csv_button=hivtrace_export_csv_button;datamonkey.hivtrace.convert_to_csv=hivtrace_convert_to_csv;datamonkey.hivtrace.betweenness_centrality=hivtrace_compute_betweenness_centrality;datamonkey.hivtrace.betweenness_centrality_all_nodes_in_cluster=hivtrace_compute_betweenness_centrality_all_nodes_in_cluster;datamonkey.hivtrace.cluster_adjacency_list=hivtrace_cluster_adjacency_list;datamonkey.hivtrace.new_cluster_adjacency_list=hivtrace_new_cluster_adjacency_list;datamonkey.hivtrace.analysis_settings=hivtrace_render_settings;datamonkey.hivtrace.export_table_to_text=hiv_trace_export_table_to_text;datamonkey.hivtrace.compute_local_clustering=hivtrace_compute_local_clustering_coefficients;datamonkey.hivtrace.undefined=new Object;datamonkey.hivtrace.too_large=new Object;datamonkey.hivtrace.processing=new Object;datamonkey.hivtrace.format_value=hivtrace_format_value;if(!datamonkey){var datamonkey={}}datamonkey.relax=function(){settings={omegaPlot:{},"tree-options":{"datamonkey-relax-tree-model":[null,true],"datamonkey-relax-tree-highlight":[null,false],"datamonkey-relax-tree-branch-lengths":[true,true],"datamonkey-relax-tree-fill-legend":[true,false],"datamonkey-relax-tree-fill-color":[true,false]},"suppress-tree-render":false,"chart-append-html":true};var e=800,t=600,r=.05,n=d3.format(".3r"),a=d3.format(".2p"),o=d3.format(".2f"),i=d3.format(".4f"),l=null,s=[],c=[];var d=d3.layout.phylotree("body").size([t,e]).separation(function(e,t){return 0});p();set_tree_handlers(d);var u=d3.select("#tree_container").append("svg").attr("width",e).attr("height",t);var f=.33;function p(){$("#datamonkey-relax-error-hide").on("click",function(e){d3.select("#datamonkey-relax-error").style("display","none");e.preventDefault()});$("#datamonkey-relax-load-json").on("change",function(e){var t=e.target.files;if(t.length==1){var r=t[0];var n=new FileReader;n.onload=function(e){return function(e){l=JSON.parse(e.target.result);render(l)}}(r);n.readAsText(r)}e.preventDefault()});$(".datamonkey-relax-tree-trigger").on("click",function(e){render_tree()})}function h(){d.branch_name(null);d.node_span("equal");d.options({"draw-size-bubbles":false,selectable:false},false);d.font_size(18);d.scale_bar_font_size(14);d.node_circle_size(0);d.branch_length(function(e){if(c){return c[e.name]||0}return undefined});d.style_edges(v);d.style_nodes(y);d.spacing_x(30,true)}render_color_scheme=function(e,t,r){var n=d3.select("#"+e).selectAll("svg").data([omega_color.domain()]);n.enter().append("svg");n.selectAll("*").remove();if(s&&!r){var a=70,o=300,i={bottom:30,top:15,left:40,right:2};n.attr("width",a).attr("height",o);this_grad=n.append("defs").append("linearGradient").attr("id","_omega_bar").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");var l=d3.scale.pow().exponent(f).domain(d3.extent(omega_color.domain())).range([0,1]),c=d3.scale.pow().exponent(f).domain(d3.extent(omega_color.domain())).range([0,o-i["top"]-i["bottom"]]);omega_color.domain().forEach(function(e){this_grad.append("stop").attr("offset",""+l(e)*100+"%").style("stop-color",omega_color(e))});var d=n.append("g").attr("transform","translate("+i["left"]+","+i["top"]+")");d.append("rect").attr("x",0).attr("width",a-i["left"]-i["right"]).attr("y",0).attr("height",o-i["top"]-i["bottom"]).style("fill","url(#_omega_bar)");var u=d3.svg.axis().scale(c).orient("left").tickFormat(d3.format(".1r")).tickValues([0,.01,.1,.5,1,2,5,10]);var p=d.append("g");p.style("font-size","14").attr("class","omega-bar").call(u);p.selectAll("text").style("text-anchor","right");var h=_label=p.append("g").attr("class","omega-bar");h=h.selectAll("text").data([t]);h.enter().append("text");h.text(function(e){return $("<textarea />").html(e).text()}).attr("transform","translate("+(a-i["left"]-i["right"])*.5+","+(o-i["bottom"])+")").style("text-anchor","middle").style("font-size","18").attr("dx","0.0em").attr("dy","0.1em")}};render_tree=function(e){if(!settings["suppress-tree-render"]){var t=false;for(var r in settings["tree-options"]){var n=d3.select("#"+r),a=n.attr("value")||n.property("checked");if(a!=settings["tree-options"][r][0]){settings["tree-options"][r][0]=a;t=t||settings["tree-options"][r][1]}}var o=settings["tree-options"]["datamonkey-relax-tree-model"][0];c=settings["tree-options"]["datamonkey-relax-tree-branch-lengths"][0]?l["fits"][o]["branch-lengths"]:null;s=l["fits"][o]["branch-annotations"];partition=(settings["tree-options"]["datamonkey-relax-tree-highlight"]?l["partition"][settings["tree-options"]["datamonkey-relax-tree-highlight"][0]]:null)||null;omega_color=d3.scale.pow().exponent(f).domain([0,.25,1,5,10]).range(settings["tree-options"]["datamonkey-relax-tree-fill-color"][0]?["#5e4fa2","#3288bd","#e6f598","#f46d43","#9e0142"]:["#DDDDDD","#AAAAAA","#888888","#444444","#000000"]).clamp(true);render_color_scheme("color_legend",l["fits"][o]["annotation-tag"],!settings["tree-options"]["datamonkey-relax-tree-fill-legend"][0]);if(!e){if(t){d.update_layout()}d3_phylotree_trigger_refresh(d)}}};function m(e){d3.select("#datamonkey-relax-error-text").text(e);d3.select("#datamonkey-relax-error").style("display","block")}render=function(e){try{l=e;d3.select("#summary-pmid").text("PubMed ID "+e["PMID"]).attr("href","http://www.ncbi.nlm.nih.gov/pubmed/"+e["PMID"]);var t=e["fits"]["Alternative"]["K"];var s=e["relaxation-test"]["p"];d3.select("#summary-direction").text(t>1?"intensification":"relaxation");d3.select("#summary-evidence").text(s<=r?"significant":"not significant");d3.select("#summary-pvalue").text(i(s));d3.select("#summary-LRT").text(o(e["relaxation-test"]["LR"]));d3.select("#summary-K").text(o(t));d3.select("#datamonkey-relax-error").style("display","none");var c=[];var f={};for(var p in e["fits"]){var v=[],y=e["fits"][p];v=[y["display-order"],"",p,o(y["log-likelihood"]),y["parameters"],o(y["AIC-c"]),g(y["runtime"]),o(d3.values(y["branch-lengths"]).reduce(function(e,t){return e+t},0))];f[p]={};var b=[];for(var x in y["rate-distributions"]){var k=y["rate-distributions"][x];var w=[x,"","",""];f[p][x]=k.map(function(e){return{omega:e[0],weight:e[1]}});for(var A=0;A<k.length;A++){w[A+1]=n(k[A][0])+" ("+a(k[A][1])+")"}b.push(w)}b.sort(function(e,t){return e[0]<t[0]?-1:e[0]==t[0]?0:1});v=v.concat(b[0]);v[1]=b[0][0];c.push(v);for(var x=1;x<b.length;x++){var w=v.map(function(e,t){if(t)return"";return e});w[1]=b[x][0];for(var A=w.length-4;A<w.length;A++){w[A]=b[x][A-w.length+4]}c.push(w)}}c.sort(function(e,t){if(e[0]==t[0]){return e[1]<t[1]?-1:e[1]==t[1]?0:1}return e[0]-t[0]});c=c.map(function(e){return e.slice(2)});model_rows=d3.select("#summary-model-table").selectAll("tr").data(c);model_rows.enter().append("tr");model_rows.exit().remove();model_rows=model_rows.selectAll("td").data(function(e){return e});model_rows.enter().append("td");model_rows.html(function(e){return e});_.templateSettings={evaluate:/\{\%(.+?)\%\}/g,interpolate:/\{\{(.+?)\}\}/g,variable:"rc"};var E=_.template($("script.omega-plots").html());_.map(f,function(e,t){e.key=t.toLowerCase().replace(/ /g,"-");e.label=t});var z=_.filter(f,function(e){return e.hasOwnProperty("Reference")});var D=E(z);if(settings["chart-append-html"]){$("#omega-plots").append(D);settings["chart-append-html"]=false}_.each(z,function(e,t){var r=e.key+"-svg";var n="#"+e.key;var a="#export-"+e.key+"-svg";var o="#export-"+e.key+"-png";if(e.hasOwnProperty("Reference")){omegaPlot(e["Reference"],e["Test"],{svg:r});d3.select(n).style("display","block");$(a).on("click",function(e){datamonkey.save_image("svg","#"+r)});$(o).on("click",function(e){datamonkey.save_image("png","#"+r)})}});settings["suppress-tree-render"]=true;var C=false;var N=d3.select("#datamonkey-relax-tree-model-list").selectAll("li").data(d3.keys(e["fits"]).map(function(e){return[e]}).sort());N.enter().append("li");N.exit().remove();N=N.selectAll("a").data(function(e){return e});N.enter().append("a");N.attr("href","#").on("click",function(e,t){d3.select("#datamonkey-relax-tree-model").attr("value",e);render_tree()});N.text(function(e){if(e=="General Descriptive"){C=true;this.click()}if(!C&&e=="Alternative"){C=true;this.click()}if(!C&&e=="Partitioned MG94xREV"){C=true;this.click()}return e});var I=d3.select("#datamonkey-relax-tree-highlight-branches").selectAll("li").data([["None"]].concat(d3.keys(e["partition"]).map(function(e){return[e]}).sort()));I.enter().append("li");I.exit().remove();I=I.selectAll("a").data(function(e){return e});I.enter().append("a");I.attr("href","#").on("click",function(e,t){d3.select("#datamonkey-relax-tree-highlight").attr("value",e);render_tree()});I.text(function(e){if(e=="RELAX.test"){this.click()}return e});settings["suppress-tree-render"]=false;render_tree(true);h();d(l["tree"]).svg(u);d.layout()}catch(M){m(M.message)}};function g(e){var t="";e=parseFloat(e);var r=[Math.floor(e/(24*3600)),Math.floor(e/3600)%24,Math.floor(e/60)%60,e%60],n=["d.","hrs.","min.","sec."];r.forEach(function(e,r){if(e){t+=" "+e+" "+n[r]}});return t}function v(e,t){if(s){e.style("stroke",omega_color(s[t.target.name])||null);$(e[0][0]).tooltip("destroy");$(e[0][0]).tooltip({title:n(s[t.target.name]),html:true,trigger:"hover",container:"body",placement:"auto"})}else{e.style("stroke",null);$(e[0][0]).tooltip("destroy")}e.style("stroke-width",partition&&partition[t.target.name]?"8":"4").style("stroke-linejoin","round").style("stroke-linecap","round")}function y(e,t){if(partition){e.style("opacity",partition&&partition[t.name]?"1":"0.25")}else{e.style("opacity","1")}}omegaPlot=function(e,t,r){makeSpring=function(e,t,r,n,a,o){if(e==t){r=Math.min(r,n);return"M"+e+","+(r-40)+"v20"}var i=[],l=[e,r],s=Math.atan2(n-r,t-e);a=[a*Math.cos(s),a*Math.sin(s)];k=0;if(Math.abs(e-t)<15){i.push(l)}else{while(e<t&&l[0]<t-15||e>t&&l[0]>t+15){l=l.map(function(e,t){return e+a[t]});if(k%2){i.push([l[0],l[1]+o])}else{i.push([l[0],l[1]-o])}k++;if(k>100){break}}}if(i.length>1){i.pop()}i.push([t,n]);var c=d3.svg.line().interpolate("monotone");return c(i)};var n=r["svg"]||"primary_omega_plot";var a=r["legend"]||null;var o=r["log"]||true;var i=false;if(o){i=e.some(function(e){return e.omega<=0});if(t){i=i||e.some(function(e){return e.omega<=0})}}var l=r["dimensions"]||{width:600,height:400};var s={left:50,right:15,bottom:35,top:35},c=l["width"]-s["left"]-s["right"],d=l["height"]-s["top"]-s["bottom"];var u=r["k"]||null;var f=r["domain"]||d3.extent(t?t.map(function(e){return e.omega}).concat(e.map(function(e){return e.omega})):e.map(function(e){return e.omega}));f[0]*=.5;var p=(o?i?d3.scale.pow().exponent(.2):d3.scale.log():d3.scale.linear()).range([0,c]).domain(f).nice(),h=d3.scale.linear().range([d,0]).domain([-.05,1]).clamp(true);var m=d3.select("#"+n).attr("width",l.width).attr("height",l.height),g=m.selectAll(".container");m.selectAll("defs").remove();m.append("defs").append("marker").attr("id","arrowhead").attr("refX",10).attr("refY",4).attr("markerWidth",10).attr("markerHeight",8).attr("orient","auto").attr("stroke","#000").attr("fill","#000").append("path").attr("d","M 0,0 V8 L10,4 Z");if(g.empty()){g=m.append("g").attr("class","container")}g.attr("transform","translate("+s["left"]+" , "+s["top"]+")");var v=g.selectAll(".omega-line-reference"),_=g.selectAll(".displacement-line");if(t){var y=e.map(function(e,r){return{x1:e.omega,x2:t[r].omega,y1:e.weight*.98,y2:t[r].weight*.98}});_=_.data(y);_.enter().append("path");_.exit().remove();_.transition().attr("d",function(e){return makeSpring(p(e.x1),p(e.x2),h(e.y1*.5),h(e.y2*.5),5,5)}).attr("marker-end","url(#arrowhead)").attr("class","displacement-line");v=v.data(e);v.enter().append("line");v.exit().remove();v.transition().attr("x1",function(e){return p(e.omega)}).attr("x2",function(e){return p(e.omega)}).attr("y1",function(e){return h(-.05)}).attr("y2",function(e){return h(e.weight)}).style("stroke",function(e){return"#d62728"}).attr("class","omega-line-reference")}else{v.remove();_.remove()}var b=g.selectAll(".omega-line").data(t?t:e);b.enter().append("line");b.exit().remove();b.transition().attr("x1",function(e){return p(e.omega)}).attr("x2",function(e){return p(e.omega)}).attr("y1",function(e){return h(-.05)}).attr("y2",function(e){return h(e.weight)}).style("stroke",function(e){return"#1f77b4"}).attr("class","omega-line");var x=g.selectAll(".neutral-line").data([1]);x.enter().append("line").attr("class","neutral-line");x.exit().remove();x.transition().attr("x1",function(e){return p(e)}).attr("x2",function(e){return p(e)}).attr("y1",0).attr("y2",d);var w=d3.svg.axis().scale(p).orient("bottom");if(o){w.ticks(10,i?".2r":".1r")}var A=m.selectAll(".x.axis");var $;if(A.empty()){A=m.append("g").attr("class","x axis");$=A.append("g").attr("class","axis-label x-label")}else{$=A.select(".axis-label.x-label")}A.attr("transform","translate("+s["left"]+","+(d+s["top"])+")").call(w);$=$.attr("transform","translate("+c+","+s["bottom"]+")").selectAll("text").data(["ω"]);$.enter().append("text");$.text(function(e){return e}).style("text-anchor","end").attr("dy","0.0em");var E=d3.svg.axis().scale(h).orient("left").ticks(10,".1p");var z=m.selectAll(".y.axis");var D;if(z.empty()){z=m.append("g").attr("class","y axis");D=z.append("g").attr("class","axis-label y-label")}else{D=z.select(".axis-label.y-label")}z.attr("transform","translate("+s["left"]+","+s["top"]+")").call(E);D=D.attr("transform","translate("+-s["left"]+","+0+")").selectAll("text").data(["Proportion of sites"]);D.enter().append("text");D.text(function(e){return e}).style("text-anchor","start").attr("dy","-1em")}};