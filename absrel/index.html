<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset="utf-8">

    <link rel="stylesheet" href="../vendor/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../vendor/bootstrap/dist/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../vendor/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="../vendor/phylotree/phylotree.css">
    <link href="../hyphy-vision.css" rel="stylesheet">

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <script src="../vendor/jquery/dist/jquery.js"></script>
    <script src="../vendor/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../vendor/underscore/underscore-min.js"></script>
    <script src="../vendor/d3/d3.min.js"></script>
    <script src="../vendor/phylotree/phylotree.js"></script>
    <script src="../vendor/react/react-with-addons.js"></script>

    <script src="../hyphy-vision.js"></script>

</head>

<body style='padding-top: 70px;'>

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">

        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">BS-REL results</a>
            </div>


            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="navbar-collapse-1">

                <ul class="nav nav-pills navbar-right" role="tablist" id='navigation_buttons'>
                    <li class="active"><a href="#summary-tab" role="tab" data-toggle="tab"><i class="fa fa-list" style = 'margin-right: 5px'></i>Summary</a></li>
                    <li><a class="tree-tab-btn" href="#tree-tab" role="tab" data-toggle="tab"><i class="fa fa-tree" style = 'margin-right: 5px'></i> Tree</a></li>
                    <li><a href="#table_tab" role="tab" data-toggle="tab"><i class="fa fa-table" style = 'margin-right: 5px'></i> Table</a></li>
                </ul>

                <ul class="nav navbar-nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" id = "datamonkey-absrel-toggle-here" data-toggle="dropdown">Load file<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li>
                                <input type="file" id="datamonkey-absrel-json-file">
                            </li>
                        </ul>
                    </li>
                 </ul>


            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <div class='container-fluid'>

        <div id='datamonkey-absrel-error' class="alert alert-danger alert-dismissible" role="alert" style="display:none;">
            <button type="button" class="close" id='datamonkey-absrel-error-hide'><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <strong>Error!</strong> <span id='datamonkey-absrel-error-text'></span>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="summary-tab">
                <div class="row">
                  <div id="summary-div" class="col-md-12"></div>
                </div> 
                <div class="row">
                    <div id="hyphy-tree-summary" class="col-md-6"></div>
                    <div id="hyphy-model-fits" class="col-md-6"></div>
                </div>
            </div>

            <div class='tab-pane' id="tree-tab"></div>

            <div class='tab-pane' id="table_tab"></div>
        </div>
    </div>

    <img id="hyphy-chart-image" />
    <canvas id="hyphy-chart-canvas"></canvas>


    <script>


        var edgeColorizer = function(element, data) {

            var self = this;

            var svg = $(element[0]).closest("svg");
            var svg_defs = d3.select(svg.get(0)).selectAll("defs");

            if (svg_defs.empty()) {
              svg_defs = svg.append("defs");
            }   

            var scaling_exponent = 0.33,
                omega_format = d3.format(".3r"),
                prop_format = d3.format(".2p"),
                fit_format = d3.format(".2f"),
                p_value_format = d3.format(".4f");

            self.omega_color = d3.scale.pow().exponent(scaling_exponent)
                .domain([0, 0.25, 1, 5, 10])
                .range(
                  self.options()["color-fill"]
                    ? ["#DDDDDD", "#AAAAAA", "#888888", "#444444", "#000000"] 
                    : ["#5e4fa2", "#3288bd", "#e6f598", "#f46d43", "#9e0142"])
                .clamp(true);


            var createBranchGradient = function(node) {

                function generateGradient(svg_defs, grad_id, annotations, already_cumulative) {

                    var current_weight = 0;
                    var this_grad = svg_defs.append("linearGradient")
                        .attr("id", grad_id);

                    annotations.forEach(function(d, i) {

                        if (d.prop) {
                            var new_weight = current_weight + d.prop;
                            this_grad.append("stop")
                                .attr("offset", "" + current_weight * 100 + "%")
                                .style("stop-color", self.omega_color(d.omega));
                            this_grad.append("stop")
                                .attr("offset", "" + new_weight * 100 + "%")
                                .style("stop-color", self.omega_color(d.omega));
                            current_weight = new_weight;
                        }
                    });
                }

                // Create svg definitions
                if(self.gradient_count == undefined) {
                  self.gradient_count = 0;
                }

                if(node.annotations) { 

                  if (node.annotations.length == 1) {
                    node['color'] = self.omega_color(node.annotations[0]["omega"]);
                  } else {
                    self.gradient_count++;
                    var grad_id = "branch_gradient_" + self.gradient_count;
                    generateGradient(svg_defs, grad_id, node.annotations.omegas);
                    node['grad'] = grad_id;
                  }

                }
            }

            var annotations = data.target.annotations,
                alpha_level = 0.05,
                tooltip = "<b>" + data.target.name + "</b>",
                reference_omega_weight =  prop_format(0),
                distro = '';

            if (annotations) {

                reference_omega_weight = annotations.omegas[0].prop;
 
                annotations.omegas.forEach(function(d, i) {

                    var omega_value = d.omega > 1e20 ? "&infin;" : omega_format(d.omega),
                        omega_weight = prop_format(d.prop);

                    tooltip += "<br/>&omega;<sub>" + (i + 1) + "</sub> = " + omega_value +
                        " (" + omega_weight + ")";

                    if (i) {
                      distro += "<br/>";
                    }

                    distro += "&omega;<sub>" + (i + 1) + "</sub> = " + omega_value +
                        " (" + omega_weight + ")";


                });

                tooltip += "<br/><i>p = " + omega_format(annotations["p"]) + "</i>";

                $(element[0][0]).tooltip({
                    'title': tooltip,
                    'html': true,
                    'trigger': 'hover',
                    'container': 'body',
                    'placement': 'auto'
                });

                createBranchGradient(data.target);

                if(data.target.grad) {
                  element.style('stroke', 'url(#' + data.target.grad + ')');
                } else {
                  element.style('stroke', data.target.color);
                }

                element.style('stroke-width', annotations["p"] <= alpha_level ? '12' : '5')
                    .style('stroke-linejoin', 'round')
                    .style('stroke-linecap', 'round');

          }

        }

        var model_fits_id = "#hyphy-model-fits";
        var omega_plots_id = "#hyphy-omega-plots";
        var summary_id = "#hyphy-relax-summary";
        var tree_id = "#tree-tab";

        var tree_settings = {
            'omegaPlot': {},
            'tree-options': {
                /* value arrays have the following meaning
                    [0] - the value of the attribute
                    [1] - does the change in attribute value trigger tree re-layout?
                */
                'hyphy-tree-model': ['Full model', true],
                'hyphy-tree-highlight': [null, false],
                'hyphy-tree-branch-lengths': [true, true],
                'hyphy-tree-hide-legend': [false, true],
                'hyphy-tree-fill-color': [true, true]
            },
            'suppress-tree-render': false,
            'chart-append-html' : true,
            'edgeColorizer' : edgeColorizer
        };

        $(document).ready(function() {



           $("#datamonkey-absrel-json-file").on("change", function(e) {
               var files = e.target.files; // FileList object

               if (files.length == 1) {
                   var f = files[0];
                   var reader = new FileReader();

                   reader.onload = (function(theFile) {
                       return function(e) {
                           bsrel_app(JSON.parse(e.target.result));
                       };
                   })(f);
                   reader.readAsText(f);
               }

               $("#datamonkey-absrel-toggle-here").dropdown("toggle");
               e.preventDefault();
           });

           $("#export-phylo-svg").on('click', function(e) {
               datamonkey.save_image("svg", "#tree_container");
           });

           $("#export-phylo-png").on('click', function(e) {
               datamonkey.save_image("png", "#tree_container");
           });

           $("#export-chart-svg").on('click', function(e) {
               datamonkey.save_image("svg", "#primary_omega_plot");
           });

           $("#export-chart-png").on('click', function(e) {
               datamonkey.save_image("png", "#primary_omega_plot");
           });

           d3.json("test-data/test.json", function(json) {

              var formatBranchAnnotations = function(key) {

                var initial_branch_annotations = json["fits"][key]["branch-annotations"];
                
                // Iterate over objects
                branch_annotations = _.mapObject(initial_branch_annotations, function(val, key) {
                  var vals = JSON.parse(val);
                  var omegas = {"omegas" : _.map(vals, function(d) { return _.object(["omega","prop"], d)})};
                  var test_results = _.clone(json["test results"][key]);
                  _.extend(test_results, omegas);
                  return test_results;
                });

                return branch_annotations;

              }


              var model_fits_id = "#hyphy-model-fits";

              json["fits"]["MG94"]["branch-annotations"] = formatBranchAnnotations("MG94");
              json["fits"]["Full model"]["branch-annotations"] = formatBranchAnnotations("Full model");
              
              // return tree
              var tree_component = render_tree(json, tree_id, tree_settings);

              render_model_fits(json, "#hyphy-model-fits");

              // We will need to have two trees, unfortunately
              render_tree_summary(json, "#hyphy-tree-summary");

              var test_results = json["test results"]; 
              render_branch_table(tree_component.tree, test_results, json["fits"]["Full model"]["branch-annotations"], "#table_tab");


              var summary_element = "summary-div";
              var pmid = json["PMID"]; 

              render_absrel_summary(test_results, pmid, summary_element);

           });
       });
               
    </script>
</body>

</html>
